import { hasLength, hasValue, isString, isArrayFull, isDate, isDateString, isObject, isStringFull, objKeys, isNil, } from '../util';
import { RequestQueryException } from './exceptions';
import { RequestQueryBuilder } from './request-query.builder';
import { validateCondition, validateJoin, validateNumeric, validateParamOption, validateSort, validateUUID, } from './request-query.validator';
// tslint:disable:variable-name ban-types
var RequestQueryParser = /** @class */ (function () {
    function RequestQueryParser() {
        this.fields = [];
        this.paramsFilter = [];
        this.authPersist = undefined;
        this.filter = [];
        this.or = [];
        this.join = [];
        this.sort = [];
    }
    Object.defineProperty(RequestQueryParser.prototype, "_options", {
        get: function () {
            return RequestQueryBuilder.getOptions();
        },
        enumerable: true,
        configurable: true
    });
    RequestQueryParser.create = function () {
        return new RequestQueryParser();
    };
    RequestQueryParser.prototype.getParsed = function () {
        return {
            fields: this.fields,
            paramsFilter: this.paramsFilter,
            authPersist: this.authPersist,
            search: this.search,
            filter: this.filter,
            or: this.or,
            join: this.join,
            sort: this.sort,
            limit: this.limit,
            offset: this.offset,
            page: this.page,
            cache: this.cache,
        };
    };
    RequestQueryParser.prototype.parseQuery = function (query) {
        if (isObject(query)) {
            var paramNames = objKeys(query);
            if (hasLength(paramNames)) {
                this._query = query;
                this._paramNames = paramNames;
                var searchData = this._query[this.getParamNames('search')[0]];
                this.search = this.parseSearchQueryParam(searchData);
                if (isNil(this.search)) {
                    this.filter = this.parseQueryParam('filter', this.conditionParser.bind(this, 'filter'));
                    this.or = this.parseQueryParam('or', this.conditionParser.bind(this, 'or'));
                }
                this.fields =
                    this.parseQueryParam('fields', this.fieldsParser.bind(this))[0] || [];
                this.join = this.parseQueryParam('join', this.joinParser.bind(this));
                this.sort = this.parseQueryParam('sort', this.sortParser.bind(this));
                this.limit = this.parseQueryParam('limit', this.numericParser.bind(this, 'limit'))[0];
                this.offset = this.parseQueryParam('offset', this.numericParser.bind(this, 'offset'))[0];
                this.page = this.parseQueryParam('page', this.numericParser.bind(this, 'page'))[0];
                this.cache = this.parseQueryParam('cache', this.numericParser.bind(this, 'cache'))[0];
            }
        }
        return this;
    };
    RequestQueryParser.prototype.parseParams = function (params, options) {
        var _this = this;
        if (isObject(params)) {
            var paramNames = objKeys(params);
            if (hasLength(paramNames)) {
                this._params = params;
                this._paramsOptions = options;
                this.paramsFilter = paramNames
                    .map(function (name) { return _this.paramParser(name); })
                    .filter(function (filter) { return filter; });
            }
        }
        return this;
    };
    RequestQueryParser.prototype.setAuthPersist = function (persist) {
        if (persist === void 0) { persist = {}; }
        this.authPersist = persist || /* istanbul ignore next */ {};
    };
    RequestQueryParser.prototype.convertFilterToSearch = function (filter) {
        var _a, _b;
        var isEmptyValue = {
            isnull: true,
            notnull: true,
        };
        return filter
            ? (_a = {},
                _a[filter.field] = (_b = {},
                    _b[filter.operator] = isEmptyValue[filter.operator]
                        ? isEmptyValue[filter.operator]
                        : filter.value,
                    _b),
                _a) : /* istanbul ignore next */ {};
    };
    RequestQueryParser.prototype.getParamNames = function (type) {
        var _this = this;
        return this._paramNames.filter(function (p) {
            var name = _this._options.paramNamesMap[type];
            return isString(name) ? name === p : name.some(function (m) { return m === p; });
        });
    };
    RequestQueryParser.prototype.getParamValues = function (value, parser) {
        if (isStringFull(value)) {
            return [parser.call(this, value)];
        }
        if (isArrayFull(value)) {
            return value.map(function (val) { return parser(val); });
        }
        return [];
    };
    RequestQueryParser.prototype.parseQueryParam = function (type, parser) {
        var _this = this;
        var param = this.getParamNames(type);
        if (isArrayFull(param)) {
            return param.reduce(function (a, name) { return Object.assign(a, _this.getParamValues(_this._query[name], parser)); }, []);
        }
        return [];
    };
    RequestQueryParser.prototype.parseValue = function (val) {
        try {
            var parsed = JSON.parse(val);
            if (!isDate(parsed) && isObject(parsed)) {
                // throw new Error('Don\'t support object now');
                return val;
            }
            else if (typeof parsed === 'number' &&
                parsed.toLocaleString('fullwide', { useGrouping: false }) !== val) {
                // JS cannot handle big numbers. Leave it as a string to prevent data loss
                return val;
            }
            return parsed;
        }
        catch (ignored) {
            if (isDateString(val)) {
                return new Date(val);
            }
            return val;
        }
    };
    RequestQueryParser.prototype.parseValues = function (vals) {
        var _this = this;
        if (isArrayFull(vals)) {
            return vals.map(function (v) { return _this.parseValue(v); });
        }
        else {
            return this.parseValue(vals);
        }
    };
    RequestQueryParser.prototype.fieldsParser = function (data) {
        return data.split(this._options.delimStr);
    };
    RequestQueryParser.prototype.parseSearchQueryParam = function (d) {
        try {
            if (isNil(d)) {
                return undefined;
            }
            var data = JSON.parse(d);
            if (!isObject(data)) {
                throw new Error();
            }
            return data;
        }
        catch (_) {
            throw new RequestQueryException('Invalid search param. JSON expected');
        }
    };
    RequestQueryParser.prototype.conditionParser = function (cond, data) {
        var isArrayValue = [
            'in',
            'notin',
            'between',
            '$in',
            '$notin',
            '$between',
            '$inL',
            '$notinL',
        ];
        var isEmptyValue = ['isnull', 'notnull', '$isnull', '$notnull'];
        var param = data.split(this._options.delim);
        var field = param[0];
        var operator = param[1];
        var value = param[2] || '';
        if (isArrayValue.some(function (name) { return name === operator; })) {
            value = value.split(this._options.delimStr);
        }
        value = this.parseValues(value);
        if (!isEmptyValue.some(function (name) { return name === operator; }) && !hasValue(value)) {
            throw new RequestQueryException("Invalid " + cond + " value");
        }
        var condition = { field: field, operator: operator, value: value };
        validateCondition(condition, cond);
        return condition;
    };
    RequestQueryParser.prototype.joinParser = function (data) {
        var param = data.split(this._options.delim);
        var join = {
            field: param[0],
            select: isStringFull(param[1]) ? param[1].split(this._options.delimStr) : undefined,
        };
        validateJoin(join);
        return join;
    };
    RequestQueryParser.prototype.sortParser = function (data) {
        var param = data.split(this._options.delimStr);
        var sort = {
            field: param[0],
            order: param[1],
        };
        validateSort(sort);
        return sort;
    };
    RequestQueryParser.prototype.numericParser = function (num, data) {
        var val = this.parseValue(data);
        validateNumeric(val, num);
        return val;
    };
    RequestQueryParser.prototype.paramParser = function (name) {
        validateParamOption(this._paramsOptions, name);
        var option = this._paramsOptions[name];
        if (option.disabled) {
            return undefined;
        }
        var value = this._params[name];
        switch (option.type) {
            case 'number':
                value = this.parseValue(value);
                validateNumeric(value, "param " + name);
                break;
            case 'uuid':
                validateUUID(value, name);
                break;
            default:
                break;
        }
        return { field: option.field, operator: '$eq', value: value };
    };
    return RequestQueryParser;
}());
export { RequestQueryParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1xdWVyeS5wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXN0LWNydWQtdHlwZW9ybS1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvY3J1ZC1yZXF1ZXN0L3JlcXVlc3QtcXVlcnkucGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsTUFBTSxFQUNOLFlBQVksRUFDWixRQUFRLEVBQ1IsWUFBWSxFQUNaLE9BQU8sRUFDUCxLQUFLLEdBRU4sTUFBTSxTQUFTLENBQUM7QUFFakIsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBTXJELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsWUFBWSxFQUNaLGVBQWUsRUFDZixtQkFBbUIsRUFDbkIsWUFBWSxFQUNaLFlBQVksR0FDYixNQUFNLDJCQUEyQixDQUFDO0FBWW5DLHlDQUF5QztBQUN6QztJQUFBO1FBQ1MsV0FBTSxHQUFnQixFQUFFLENBQUM7UUFDekIsaUJBQVksR0FBa0IsRUFBRSxDQUFDO1FBQ2pDLGdCQUFXLEdBQWtCLFNBQVMsQ0FBQztRQUV2QyxXQUFNLEdBQWtCLEVBQUUsQ0FBQztRQUMzQixPQUFFLEdBQWtCLEVBQUUsQ0FBQztRQUN2QixTQUFJLEdBQWdCLEVBQUUsQ0FBQztRQUN2QixTQUFJLEdBQWdCLEVBQUUsQ0FBQztJQXlTaEMsQ0FBQztJQTlSQyxzQkFBWSx3Q0FBUTthQUFwQjtZQUNFLE9BQU8sbUJBQW1CLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDMUMsQ0FBQzs7O09BQUE7SUFFTSx5QkFBTSxHQUFiO1FBQ0UsT0FBTyxJQUFJLGtCQUFrQixFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVELHNDQUFTLEdBQVQ7UUFDRSxPQUFPO1lBQ0wsTUFBTSxFQUFFLElBQUksQ0FB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SUFBSSxFQUFFO1lBQ25CLEtBQUssUUFBUTtnQkFDWCxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDL0IsZUFBZSxDQUFDLEtBQUssRUFBRSxXQUFTLElBQU0sQ0FBQyxDQUFDO2dCQUN4QyxNQUFNO1lBQ1IsS0FBSyxNQUFNO2dCQUNULFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQzFCLE1BQU07WUFDUjtnQkFDRSxNQUFNO1NBQ1Q7UUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFDO0lBQ3pELENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUFqVEQsSUFpVEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBoYXNMZW5ndGgsXG4gIGhhc1ZhbHVlLFxuICBpc1N0cmluZyxcbiAgaXNBcnJheUZ1bGwsXG4gIGlzRGF0ZSxcbiAgaXNEYXRlU3RyaW5nLFxuICBpc09iamVjdCxcbiAgaXNTdHJpbmdGdWxsLFxuICBvYmpLZXlzLFxuICBpc05pbCxcbiAgT2JqZWN0TGl0ZXJhbCxcbn0gZnJvbSAnLi4vdXRpbCc7XG5cbmltcG9ydCB7IFJlcXVlc3RRdWVyeUV4Y2VwdGlvbiB9IGZyb20gJy4vZXhjZXB0aW9ucyc7XG5pbXBvcnQge1xuICBQYXJhbXNPcHRpb25zLFxuICBQYXJzZWRSZXF1ZXN0UGFyYW1zLFxuICBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucyxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFJlcXVlc3RRdWVyeUJ1aWxkZXIgfSBmcm9tICcuL3JlcXVlc3QtcXVlcnkuYnVpbGRlcic7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUNvbmRpdGlvbixcbiAgdmFsaWRhdGVKb2luLFxuICB2YWxpZGF0ZU51bWVyaWMsXG4gIHZhbGlkYXRlUGFyYW1PcHRpb24sXG4gIHZhbGlkYXRlU29ydCxcbiAgdmFsaWRhdGVVVUlELFxufSBmcm9tICcuL3JlcXVlc3QtcXVlcnkudmFsaWRhdG9yJztcbmltcG9ydCB7XG4gIENvbXBhcmlzb25PcGVyYXRvcixcbiAgUXVlcnlGaWVsZHMsXG4gIFF1ZXJ5RmlsdGVyLFxuICBRdWVyeUpvaW4sXG4gIFF1ZXJ5U29ydCxcbiAgU0NvbmRpdGlvbixcbiAgU0NvbmRpdGlvbkFORCxcbiAgU0ZpZWxkcyxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbi8vIHRzbGludDpkaXNhYmxlOnZhcmlhYmxlLW5hbWUgYmFuLXR5cGVzXG5leHBvcnQgY2xhc3MgUmVxdWVzdFF1ZXJ5UGFyc2VyIGltcGxlbWVudHMgUGFyc2VkUmVxdWVzdFBhcmFtcyB7XG4gIHB1YmxpYyBmaWVsZHM6IFF1ZXJ5RmllbGRzID0gW107XG4gIHB1YmxpYyBwYXJhbXNGaWx0ZXI6IFF1ZXJ5RmlsdGVyW10gPSBbXTtcbiAgcHVibGljIGF1dGhQZXJzaXN0OiBPYmplY3RMaXRlcmFsID0gdW5kZWZpbmVkO1xuICBwdWJsaWMgc2VhcmNoOiBTQ29uZGl0aW9uO1xuICBwdWJsaWMgZmlsdGVyOiBRdWVyeUZpbHRlcltdID0gW107XG4gIHB1YmxpYyBvcjogUXVlcnlGaWx0ZXJbXSA9IFtdO1xuICBwdWJsaWMgam9pbjogUXVlcnlKb2luW10gPSBbXTtcbiAgcHVibGljIHNvcnQ6IFF1ZXJ5U29ydFtdID0gW107XG4gIHB1YmxpYyBsaW1pdDogbnVtYmVyO1xuICBwdWJsaWMgb2Zmc2V0OiBudW1iZXI7XG4gIHB1YmxpYyBwYWdlOiBudW1iZXI7XG4gIHB1YmxpYyBjYWNoZTogbnVtYmVyO1xuXG4gIHByaXZhdGUgX3BhcmFtczogYW55O1xuICBwcml2YXRlIF9xdWVyeTogYW55O1xuICBwcml2YXRlIF9wYXJhbU5hbWVzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSBfcGFyYW1zT3B0aW9uczogUGFyYW1zT3B0aW9ucztcblxuICBwcml2YXRlIGdldCBfb3B0aW9ucygpOiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucyB7XG4gICAgcmV0dXJuIFJlcXVlc3RRdWVyeUJ1aWxkZXIuZ2V0T3B0aW9ucygpO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZSgpOiBSZXF1ZXN0UXVlcnlQYXJzZXIge1xuICAgIHJldHVybiBuZXcgUmVxdWVzdFF1ZXJ5UGFyc2VyKCk7XG4gIH1cblxuICBnZXRQYXJzZWQoKTogUGFyc2VkUmVxdWVzdFBhcmFtcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpZWxkczogdGhpcy5maWVsZHMsXG4gICAgICBwYXJhbXNGaWx0ZXI6IHRoaXMucGFyYW1zRmlsdGVyLFxuICAgICAgYXV0aFBlcnNpc3Q6IHRoaXMuYXV0aFBlcnNpc3QsXG4gICAgICBzZWFyY2g6IHRoaXMuc2VhcmNoLFxuICAgICAgZmlsdGVyOiB0aGlzLmZpbHRlcixcbiAgICAgIG9yOiB0aGlzLm9yLFxuICAgICAgam9pbjogdGhpcy5qb2luLFxuICAgICAgc29ydDogdGhpcy5zb3J0LFxuICAgICAgbGltaXQ6IHRoaXMubGltaXQsXG4gICAgICBvZmZzZXQ6IHRoaXMub2Zmc2V0LFxuICAgICAgcGFnZTogdGhpcy5wYWdlLFxuICAgICAgY2FjaGU6IHRoaXMuY2FjaGUsXG4gICAgfTtcbiAgfVxuXG4gIHBhcnNlUXVlcnkocXVlcnk6IGFueSk6IHRoaXMge1xuICAgIGlmIChpc09iamVjdChxdWVyeSkpIHtcbiAgICAgIGNvbnN0IHBhcmFtTmFtZXMgPSBvYmpLZXlzKHF1ZXJ5KTtcblxuICAgICAgaWYgKGhhc0xlbmd0aChwYXJhbU5hbWVzKSkge1xuICAgICAgICB0aGlzLl9xdWVyeSA9IHF1ZXJ5O1xuICAgICAgICB0aGlzLl9wYXJhbU5hbWVzID0gcGFyYW1OYW1lcztcbiAgICAgICAgbGV0IHNlYXJjaERhdGEgPSB0aGlzLl9xdWVyeVt0aGlzLmdldFBhcmFtTmFtZXMoJ3NlYXJjaCcpWzBdXTtcblxuICAgICAgICB0aGlzLnNlYXJjaCA9IHRoaXMucGFyc2VTZWFyY2hRdWVyeVBhcmFtKHNlYXJjaERhdGEpIGFzIGFueTtcbiAgICAgICAgaWYgKGlzTmlsKHRoaXMuc2VhcmNoKSkge1xuICAgICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5wYXJzZVF1ZXJ5UGFyYW0oXG4gICAgICAgICAgICAnZmlsdGVyJyxcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9uUGFyc2VyLmJpbmQodGhpcywgJ2ZpbHRlcicpLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5vciA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKCdvcicsIHRoaXMuY29uZGl0aW9uUGFyc2VyLmJpbmQodGhpcywgJ29yJykpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmllbGRzID1cbiAgICAgICAgICB0aGlzLnBhcnNlUXVlcnlQYXJhbSgnZmllbGRzJywgdGhpcy5maWVsZHNQYXJzZXIuYmluZCh0aGlzKSlbMF0gfHwgW107XG4gICAgICAgIHRoaXMuam9pbiA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKCdqb2luJywgdGhpcy5qb2luUGFyc2VyLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLnNvcnQgPSB0aGlzLnBhcnNlUXVlcnlQYXJhbSgnc29ydCcsIHRoaXMuc29ydFBhcnNlci5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5saW1pdCA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKFxuICAgICAgICAgICdsaW1pdCcsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ2xpbWl0JyksXG4gICAgICAgIClbMF07XG4gICAgICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5wYXJzZVF1ZXJ5UGFyYW0oXG4gICAgICAgICAgJ29mZnNldCcsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ29mZnNldCcpLFxuICAgICAgICApWzBdO1xuICAgICAgICB0aGlzLnBhZ2UgPSB0aGlzLnBhcnNlUXVlcnlQYXJhbShcbiAgICAgICAgICAncGFnZScsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ3BhZ2UnKSxcbiAgICAgICAgKVswXTtcbiAgICAgICAgdGhpcy5jYWNoZSA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKFxuICAgICAgICAgICdjYWNoZScsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ2NhY2hlJyksXG4gICAgICAgIClbMF07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwYXJzZVBhcmFtcyhwYXJhbXM6IGFueSwgb3B0aW9uczogUGFyYW1zT3B0aW9ucyk6IHRoaXMge1xuICAgIGlmIChpc09iamVjdChwYXJhbXMpKSB7XG4gICAgICBjb25zdCBwYXJhbU5hbWVzID0gb2JqS2V5cyhwYXJhbXMpO1xuXG4gICAgICBpZiAoaGFzTGVuZ3RoKHBhcmFtTmFtZXMpKSB7XG4gICAgICAgIHRoaXMuX3BhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgdGhpcy5fcGFyYW1zT3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMucGFyYW1zRmlsdGVyID0gcGFyYW1OYW1lc1xuICAgICAgICAgIC5tYXAoKG5hbWUpID0+IHRoaXMucGFyYW1QYXJzZXIobmFtZSkpXG4gICAgICAgICAgLmZpbHRlcigoZmlsdGVyKSA9PiBmaWx0ZXIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0QXV0aFBlcnNpc3QocGVyc2lzdDogT2JqZWN0TGl0ZXJhbCA9IHt9KSB7XG4gICAgdGhpcy5hdXRoUGVyc2lzdCA9IHBlcnNpc3QgfHwgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8ge307XG4gIH1cblxuICBjb252ZXJ0RmlsdGVyVG9TZWFyY2goZmlsdGVyOiBRdWVyeUZpbHRlcik6IFNGaWVsZHMgfCBTQ29uZGl0aW9uQU5EIHtcbiAgICBjb25zdCBpc0VtcHR5VmFsdWUgPSB7XG4gICAgICBpc251bGw6IHRydWUsXG4gICAgICBub3RudWxsOiB0cnVlLFxuICAgIH07XG5cbiAgICByZXR1cm4gZmlsdGVyXG4gICAgICA/IHtcbiAgICAgICAgICBbZmlsdGVyLmZpZWxkXToge1xuICAgICAgICAgICAgW2ZpbHRlci5vcGVyYXRvcl06IGlzRW1wdHlWYWx1ZVtmaWx0ZXIub3BlcmF0b3JdXG4gICAgICAgICAgICAgID8gaXNFbXB0eVZhbHVlW2ZpbHRlci5vcGVyYXRvcl1cbiAgICAgICAgICAgICAgOiBmaWx0ZXIudmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgOiAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLyB7fTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGFyYW1OYW1lcyhcbiAgICB0eXBlOiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddLFxuICApOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMuX3BhcmFtTmFtZXMuZmlsdGVyKChwKSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gdGhpcy5fb3B0aW9ucy5wYXJhbU5hbWVzTWFwW3R5cGVdO1xuICAgICAgcmV0dXJuIGlzU3RyaW5nKG5hbWUpID8gbmFtZSA9PT0gcCA6IChuYW1lIGFzIHN0cmluZ1tdKS5zb21lKChtKSA9PiBtID09PSBwKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGFyYW1WYWx1ZXModmFsdWU6IHN0cmluZyB8IHN0cmluZ1tdLCBwYXJzZXI6IEZ1bmN0aW9uKTogc3RyaW5nW10ge1xuICAgIGlmIChpc1N0cmluZ0Z1bGwodmFsdWUpKSB7XG4gICAgICByZXR1cm4gW3BhcnNlci5jYWxsKHRoaXMsIHZhbHVlKV07XG4gICAgfVxuXG4gICAgaWYgKGlzQXJyYXlGdWxsKHZhbHVlKSkge1xuICAgICAgcmV0dXJuICh2YWx1ZSBhcyBzdHJpbmdbXSkubWFwKCh2YWwpID0+IHBhcnNlcih2YWwpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUXVlcnlQYXJhbShcbiAgICB0eXBlOiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddLFxuICAgIHBhcnNlcjogRnVuY3Rpb24sXG4gICkge1xuICAgIGNvbnN0IHBhcmFtID0gdGhpcy5nZXRQYXJhbU5hbWVzKHR5cGUpO1xuXG4gICAgaWYgKGlzQXJyYXlGdWxsKHBhcmFtKSkge1xuICAgICAgcmV0dXJuIHBhcmFtLnJlZHVjZShcbiAgICAgICAgKGEsIG5hbWUpID0+IE9iamVjdC5hc3NpZ24oYSx0aGlzLmdldFBhcmFtVmFsdWVzKHRoaXMuX3F1ZXJ5W25hbWVdLCBwYXJzZXIpKSxcbiAgICAgICAgW10sXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VWYWx1ZSh2YWw6IGFueSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHZhbCk7XG5cbiAgICAgIGlmICghaXNEYXRlKHBhcnNlZCkgJiYgaXNPYmplY3QocGFyc2VkKSkge1xuICAgICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoJ0RvblxcJ3Qgc3VwcG9ydCBvYmplY3Qgbm93Jyk7XG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB0eXBlb2YgcGFyc2VkID09PSAnbnVtYmVyJyAmJlxuICAgICAgICBwYXJzZWQudG9Mb2NhbGVTdHJpbmcoJ2Z1bGx3aWRlJywgeyB1c2VHcm91cGluZzogZmFsc2UgfSkgIT09IHZhbFxuICAgICAgKSB7XG4gICAgICAgIC8vIEpTIGNhbm5vdCBoYW5kbGUgYmlnIG51bWJlcnMuIExlYXZlIGl0IGFzIGEgc3RyaW5nIHRvIHByZXZlbnQgZGF0YSBsb3NzXG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJzZWQ7XG4gICAgfSBjYXRjaCAoaWdub3JlZCkge1xuICAgICAgaWYgKGlzRGF0ZVN0cmluZyh2YWwpKSB7XG4gICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWwpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VWYWx1ZXModmFsczogYW55KSB7XG4gICAgaWYgKGlzQXJyYXlGdWxsKHZhbHMpKSB7XG4gICAgICByZXR1cm4gdmFscy5tYXAoKHY6IGFueSkgPT4gdGhpcy5wYXJzZVZhbHVlKHYpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VWYWx1ZSh2YWxzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpZWxkc1BhcnNlcihkYXRhOiBzdHJpbmcpOiBRdWVyeUZpZWxkcyB7XG4gICAgcmV0dXJuIGRhdGEuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cik7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlU2VhcmNoUXVlcnlQYXJhbShkOiBhbnkpOiBTQ29uZGl0aW9uIHtcbiAgICB0cnkge1xuICAgICAgaWYgKGlzTmlsKGQpKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGQpO1xuXG4gICAgICBpZiAoIWlzT2JqZWN0KGRhdGEpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9IGNhdGNoIChfKSB7XG4gICAgICB0aHJvdyBuZXcgUmVxdWVzdFF1ZXJ5RXhjZXB0aW9uKCdJbnZhbGlkIHNlYXJjaCBwYXJhbS4gSlNPTiBleHBlY3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29uZGl0aW9uUGFyc2VyKGNvbmQ6ICdmaWx0ZXInIHwgJ29yJyB8ICdzZWFyY2gnLCBkYXRhOiBzdHJpbmcpOiBRdWVyeUZpbHRlciB7XG4gICAgY29uc3QgaXNBcnJheVZhbHVlID0gW1xuICAgICAgJ2luJyxcbiAgICAgICdub3RpbicsXG4gICAgICAnYmV0d2VlbicsXG4gICAgICAnJGluJyxcbiAgICAgICckbm90aW4nLFxuICAgICAgJyRiZXR3ZWVuJyxcbiAgICAgICckaW5MJyxcbiAgICAgICckbm90aW5MJyxcbiAgICBdO1xuICAgIGNvbnN0IGlzRW1wdHlWYWx1ZSA9IFsnaXNudWxsJywgJ25vdG51bGwnLCAnJGlzbnVsbCcsICckbm90bnVsbCddO1xuICAgIGNvbnN0IHBhcmFtID0gZGF0YS5zcGxpdCh0aGlzLl9vcHRpb25zLmRlbGltKTtcbiAgICBjb25zdCBmaWVsZCA9IHBhcmFtWzBdO1xuICAgIGNvbnN0IG9wZXJhdG9yID0gcGFyYW1bMV0gYXMgQ29tcGFyaXNvbk9wZXJhdG9yO1xuICAgIGxldCB2YWx1ZSA9IHBhcmFtWzJdIHx8ICcnO1xuXG4gICAgaWYgKGlzQXJyYXlWYWx1ZS5zb21lKChuYW1lKSA9PiBuYW1lID09PSBvcGVyYXRvcikpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cikgYXMgYW55O1xuICAgIH1cblxuICAgIHZhbHVlID0gdGhpcy5wYXJzZVZhbHVlcyh2YWx1ZSk7XG5cbiAgICBpZiAoIWlzRW1wdHlWYWx1ZS5zb21lKChuYW1lKSA9PiBuYW1lID09PSBvcGVyYXRvcikgJiYgIWhhc1ZhbHVlKHZhbHVlKSkge1xuICAgICAgdGhyb3cgbmV3IFJlcXVlc3RRdWVyeUV4Y2VwdGlvbihgSW52YWxpZCAke2NvbmR9IHZhbHVlYCk7XG4gICAgfVxuXG4gICAgY29uc3QgY29uZGl0aW9uOiBRdWVyeUZpbHRlciA9IHsgZmllbGQsIG9wZXJhdG9yLCB2YWx1ZSB9O1xuICAgIHZhbGlkYXRlQ29uZGl0aW9uKGNvbmRpdGlvbiwgY29uZCk7XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBqb2luUGFyc2VyKGRhdGE6IHN0cmluZyk6IFF1ZXJ5Sm9pbiB7XG4gICAgY29uc3QgcGFyYW0gPSBkYXRhLnNwbGl0KHRoaXMuX29wdGlvbnMuZGVsaW0pO1xuICAgIGNvbnN0IGpvaW46IFF1ZXJ5Sm9pbiA9IHtcbiAgICAgIGZpZWxkOiBwYXJhbVswXSxcbiAgICAgIHNlbGVjdDogaXNTdHJpbmdGdWxsKHBhcmFtWzFdKSA/IHBhcmFtWzFdLnNwbGl0KHRoaXMuX29wdGlvbnMuZGVsaW1TdHIpIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgdmFsaWRhdGVKb2luKGpvaW4pO1xuXG4gICAgcmV0dXJuIGpvaW47XG4gIH1cblxuICBwcml2YXRlIHNvcnRQYXJzZXIoZGF0YTogc3RyaW5nKTogUXVlcnlTb3J0IHtcbiAgICBjb25zdCBwYXJhbSA9IGRhdGEuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cik7XG4gICAgY29uc3Qgc29ydDogUXVlcnlTb3J0ID0ge1xuICAgICAgZmllbGQ6IHBhcmFtWzBdLFxuICAgICAgb3JkZXI6IHBhcmFtWzFdIGFzIGFueSxcbiAgICB9O1xuICAgIHZhbGlkYXRlU29ydChzb3J0KTtcblxuICAgIHJldHVybiBzb3J0O1xuICB9XG5cbiAgcHJpdmF0ZSBudW1lcmljUGFyc2VyKFxuICAgIG51bTogJ2xpbWl0JyB8ICdvZmZzZXQnIHwgJ3BhZ2UnIHwgJ2NhY2hlJyxcbiAgICBkYXRhOiBzdHJpbmcsXG4gICk6IG51bWJlciB7XG4gICAgY29uc3QgdmFsID0gdGhpcy5wYXJzZVZhbHVlKGRhdGEpO1xuICAgIHZhbGlkYXRlTnVtZXJpYyh2YWwsIG51bSk7XG5cbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJhbVBhcnNlcihuYW1lOiBzdHJpbmcpOiBRdWVyeUZpbHRlciB7XG4gICAgdmFsaWRhdGVQYXJhbU9wdGlvbih0aGlzLl9wYXJhbXNPcHRpb25zLCBuYW1lKTtcbiAgICBjb25zdCBvcHRpb24gPSB0aGlzLl9wYXJhbXNPcHRpb25zW25hbWVdO1xuXG4gICAgaWYgKG9wdGlvbi5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBsZXQgdmFsdWUgPSB0aGlzLl9wYXJhbXNbbmFtZV07XG5cbiAgICBzd2l0Y2ggKG9wdGlvbi50eXBlKSB7XG4gICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICB2YWx1ZSA9IHRoaXMucGFyc2VWYWx1ZSh2YWx1ZSk7XG4gICAgICAgIHZhbGlkYXRlTnVtZXJpYyh2YWx1ZSwgYHBhcmFtICR7bmFtZX1gKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd1dWlkJzpcbiAgICAgICAgdmFsaWRhdGVVVUlEKHZhbHVlLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4geyBmaWVsZDogb3B0aW9uLmZpZWxkLCBvcGVyYXRvcjogJyRlcScsIHZhbHVlIH07XG4gIH1cbn1cbiJdfQ==