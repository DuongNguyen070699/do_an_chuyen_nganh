import { __assign, __read, __spread } from "tslib";
import { hasValue, isObject, isString, isArrayFull, isNil, isUndefined, } from '../util';
import { stringify } from 'qs';
import { validateCondition, validateFields, validateJoin, validateNumeric, validateSort, } from './request-query.validator';
// tslint:disable:variable-name ban-types
var RequestQueryBuilder = /** @class */ (function () {
    function RequestQueryBuilder() {
        this.paramNames = {};
        this.queryObject = {};
        this.setParamNames();
    }
    RequestQueryBuilder.setOptions = function (options) {
        RequestQueryBuilder._options = __assign(__assign(__assign({}, RequestQueryBuilder._options), options), { paramNamesMap: __assign(__assign({}, RequestQueryBuilder._options.paramNamesMap), (options.paramNamesMap ? options.paramNamesMap : {})) });
    };
    RequestQueryBuilder.getOptions = function () {
        return RequestQueryBuilder._options;
    };
    RequestQueryBuilder.create = function (params) {
        var qb = new RequestQueryBuilder();
        return isObject(params) ? qb.createFromParams(params) : qb;
    };
    Object.defineProperty(RequestQueryBuilder.prototype, "options", {
        get: function () {
            return RequestQueryBuilder._options;
        },
        enumerable: true,
        configurable: true
    });
    RequestQueryBuilder.prototype.setParamNames = function () {
        var _this = this;
        Object.keys(RequestQueryBuilder._options.paramNamesMap).forEach(function (key) {
            var name = RequestQueryBuilder._options.paramNamesMap[key];
            _this.paramNames[key] = isString(name) ? name : name[0];
        });
    };
    RequestQueryBuilder.prototype.query = function (encode) {
        if (encode === void 0) { encode = true; }
        if (this.queryObject[this.paramNames.search]) {
            this.queryObject[this.paramNames.filter] = undefined;
            this.queryObject[this.paramNames.or] = undefined;
        }
        this.queryString = stringify(this.queryObject, { encode: encode });
        return this.queryString;
    };
    RequestQueryBuilder.prototype.select = function (fields) {
        if (isArrayFull(fields)) {
            validateFields(fields);
            this.queryObject[this.paramNames.fields] = fields.join(this.options.delimStr);
        }
        return this;
    };
    RequestQueryBuilder.prototype.search = function (s) {
        if (!isNil(s) && isObject(s)) {
            this.queryObject[this.paramNames.search] = JSON.stringify(s);
        }
        return this;
    };
    RequestQueryBuilder.prototype.setFilter = function (f) {
        this.setCondition(f, 'filter');
        return this;
    };
    RequestQueryBuilder.prototype.setOr = function (f) {
        this.setCondition(f, 'or');
        return this;
    };
    RequestQueryBuilder.prototype.setJoin = function (j) {
        var _this = this;
        if (!isNil(j)) {
            var param = this.checkQueryObjectParam('join', []);
            this.queryObject[param] = __spread(this.queryObject[param], (Array.isArray(j) && !isString(j[0])
                ? j.map(function (o) { return _this.addJoin(o); })
                : [this.addJoin(j)]));
        }
        return this;
    };
    RequestQueryBuilder.prototype.sortBy = function (s) {
        var _this = this;
        if (!isNil(s)) {
            var param = this.checkQueryObjectParam('sort', []);
            this.queryObject[param] = __spread(this.queryObject[param], (Array.isArray(s) && !isString(s[0])
                ? s.map(function (o) { return _this.addSortBy(o); })
                : [this.addSortBy(s)]));
        }
        return this;
    };
    RequestQueryBuilder.prototype.setLimit = function (n) {
        this.setNumeric(n, 'limit');
        return this;
    };
    RequestQueryBuilder.prototype.setOffset = function (n) {
        this.setNumeric(n, 'offset');
        return this;
    };
    RequestQueryBuilder.prototype.setPage = function (n) {
        this.setNumeric(n, 'page');
        return this;
    };
    RequestQueryBuilder.prototype.resetCache = function () {
        this.setNumeric(0, 'cache');
        return this;
    };
    RequestQueryBuilder.prototype.cond = function (f, cond) {
        if (cond === void 0) { cond = 'search'; }
        var filter = Array.isArray(f) ? { field: f[0], operator: f[1], value: f[2] } : f;
        validateCondition(filter, cond);
        var d = this.options.delim;
        return (filter.field +
            d +
            filter.operator +
            (hasValue(filter.value) ? d + filter.value : ''));
    };
    RequestQueryBuilder.prototype.addJoin = function (j) {
        var join = Array.isArray(j) ? { field: j[0], select: j[1] } : j;
        validateJoin(join);
        var d = this.options.delim;
        var ds = this.options.delimStr;
        return join.field + (isArrayFull(join.select) ? d + join.select.join(ds) : '');
    };
    RequestQueryBuilder.prototype.addSortBy = function (s) {
        var sort = Array.isArray(s) ? { field: s[0], order: s[1] } : s;
        validateSort(sort);
        var ds = this.options.delimStr;
        return sort.field + ds + sort.order;
    };
    RequestQueryBuilder.prototype.createFromParams = function (params) {
        this.select(params.fields);
        this.search(params.search);
        this.setFilter(params.filter);
        this.setOr(params.or);
        this.setJoin(params.join);
        this.setLimit(params.limit);
        this.setOffset(params.offset);
        this.setPage(params.page);
        this.sortBy(params.sort);
        if (params.resetCache) {
            this.resetCache();
        }
        return this;
    };
    RequestQueryBuilder.prototype.checkQueryObjectParam = function (cond, defaults) {
        var param = this.paramNames[cond];
        if (isNil(this.queryObject[param]) && !isUndefined(defaults)) {
            this.queryObject[param] = defaults;
        }
        return param;
    };
    RequestQueryBuilder.prototype.setCondition = function (f, cond) {
        var _this = this;
        if (!isNil(f)) {
            var param = this.checkQueryObjectParam(cond, []);
            this.queryObject[param] = __spread(this.queryObject[param], (Array.isArray(f) && !isString(f[0])
                ? f.map(function (o) { return _this.cond(o, cond); })
                : [this.cond(f, cond)]));
        }
    };
    RequestQueryBuilder.prototype.setNumeric = function (n, cond) {
        if (!isNil(n)) {
            validateNumeric(n, cond);
            this.queryObject[this.paramNames[cond]] = n;
        }
    };
    RequestQueryBuilder._options = {
        delim: '||',
        delimStr: ',',
        paramNamesMap: {
            fields: ['fields', 'select'],
            search: 's',
            filter: 'filter',
            or: 'or',
            join: 'join',
            sort: 'sort',
            limit: ['limit', 'per_page'],
            offset: 'offset',
            page: 'page',
            cache: 'cache',
        },
    };
    return RequestQueryBuilder;
}());
export { RequestQueryBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1xdWVyeS5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmVzdC1jcnVkLXR5cGVvcm0tY2xpZW50LyIsInNvdXJjZXMiOlsibGliL2NydWQtcmVxdWVzdC9yZXF1ZXN0LXF1ZXJ5LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxRQUFRLEVBQ1IsUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsS0FBSyxFQUNMLFdBQVcsR0FDWixNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBRy9CLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsY0FBYyxFQUNkLFlBQVksRUFDWixlQUFlLEVBQ2YsWUFBWSxHQUNiLE1BQU0sMkJBQTJCLENBQUM7QUFZbkMseUNBQXlDO0FBQ3pDO0lBQ0U7UUFvQlEsZUFBVSxHQUVkLEVBQUUsQ0FBQztRQUNBLGdCQUFXLEdBQTJCLEVBQUUsQ0FBQztRQXRCOUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUF3Qk0sOEJBQVUsR0FBakIsVUFBa0IsT0FBbUM7UUFDbkQsbUJBQW1CLENBQUMsUUFBUSxrQ0FDdkIsbUJBQW1CLENBQUMsUUFBUSxHQUM1QixPQUFPLEtBQ1YsYUFBYSx3QkFDUixtQkFBbUIsQ0FBQyxRQUFRLENBQUMsYUFBYSxHQUMxQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUUxRCxDQUFDO0lBQ0osQ0FBQztJQUVNLDhCQUFVLEdBQWpCO1FBQ0UsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7SUFDdEMsQ0FBQztJQUVNLDBCQUFNLEdBQWIsVUFBYyxNQUEwQjtRQUN0QyxJQUFNLEVBQUUsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7UUFDckMsT0FBTyxRQUFRLENBQUMsTUFBTSxD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LEVBQUUsTUFBTTtZQUNaLEtBQUssRUFBRSxPQUFPO1NBQ2Y7S0FDRixDQUFDO0lBdU1KLDBCQUFDO0NBQUEsQUEzTkQsSUEyTkM7U0EzTlksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgaGFzVmFsdWUsXG4gIGlzT2JqZWN0LFxuICBpc1N0cmluZyxcbiAgaXNBcnJheUZ1bGwsXG4gIGlzTmlsLFxuICBpc1VuZGVmaW5lZCxcbn0gZnJvbSAnLi4vdXRpbCc7XG5pbXBvcnQgeyBzdHJpbmdpZnkgfSBmcm9tICdxcyc7XG5cbmltcG9ydCB7IFJlcXVlc3RRdWVyeUJ1aWxkZXJPcHRpb25zLCBDcmVhdGVRdWVyeVBhcmFtcyB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUNvbmRpdGlvbixcbiAgdmFsaWRhdGVGaWVsZHMsXG4gIHZhbGlkYXRlSm9pbixcbiAgdmFsaWRhdGVOdW1lcmljLFxuICB2YWxpZGF0ZVNvcnQsXG59IGZyb20gJy4vcmVxdWVzdC1xdWVyeS52YWxpZGF0b3InO1xuaW1wb3J0IHtcbiAgUXVlcnlGaWVsZHMsXG4gIFF1ZXJ5RmlsdGVyLFxuICBRdWVyeUZpbHRlckFycixcbiAgUXVlcnlKb2luLFxuICBRdWVyeUpvaW5BcnIsXG4gIFF1ZXJ5U29ydCxcbiAgUXVlcnlTb3J0QXJyLFxuICBTQ29uZGl0aW9uLFxufSBmcm9tICcuL3R5cGVzJztcblxuLy8gdHNsaW50OmRpc2FibGU6dmFyaWFibGUtbmFtZSBiYW4tdHlwZXNcbmV4cG9ydCBjbGFzcyBSZXF1ZXN0UXVlcnlCdWlsZGVyIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5zZXRQYXJhbU5hbWVzKCk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfb3B0aW9uczogUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnMgPSB7XG4gICAgZGVsaW06ICd8fCcsXG4gICAgZGVsaW1TdHI6ICcsJyxcbiAgICBwYXJhbU5hbWVzTWFwOiB7XG4gICAgICBmaWVsZHM6IFsnZmllbGRzJywgJ3NlbGVjdCddLFxuICAgICAgc2VhcmNoOiAncycsXG4gICAgICBmaWx0ZXI6ICdmaWx0ZXInLFxuICAgICAgb3I6ICdvcicsXG4gICAgICBqb2luOiAnam9pbicsXG4gICAgICBzb3J0OiAnc29ydCcsXG4gICAgICBsaW1pdDogWydsaW1pdCcsICdwZXJfcGFnZSddLFxuICAgICAgb2Zmc2V0OiAnb2Zmc2V0JyxcbiAgICAgIHBhZ2U6ICdwYWdlJyxcbiAgICAgIGNhY2hlOiAnY2FjaGUnLFxuICAgIH0sXG4gIH07XG4gIHByaXZhdGUgcGFyYW1OYW1lczoge1xuICAgIFtrZXkgaW4ga2V5b2YgUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnNbJ3BhcmFtTmFtZXNNYXAnXV06IHN0cmluZztcbiAgfSA9IHt9O1xuICBwdWJsaWMgcXVlcnlPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgcHVibGljIHF1ZXJ5U3RyaW5nOiBzdHJpbmc7XG5cbiAgc3RhdGljIHNldE9wdGlvbnMob3B0aW9uczogUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnMpIHtcbiAgICBSZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zID0ge1xuICAgICAgLi4uUmVxdWVzdFF1ZXJ5QnVpbGRlci5fb3B0aW9ucyxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgICBwYXJhbU5hbWVzTWFwOiB7XG4gICAgICAgIC4uLlJlcXVlc3RRdWVyeUJ1aWxkZXIuX29wdGlvbnMucGFyYW1OYW1lc01hcCxcbiAgICAgICAgLi4uKG9wdGlvbnMucGFyYW1OYW1lc01hcCA/IG9wdGlvbnMucGFyYW1OYW1lc01hcCA6IHt9KSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRPcHRpb25zKCk6IFJlcXVlc3RRdWVyeUJ1aWxkZXJPcHRpb25zIHtcbiAgICByZXR1cm4gUmVxdWVzdFF1ZXJ5QnVpbGRlci5fb3B0aW9ucztcbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUocGFyYW1zPzogQ3JlYXRlUXVlcnlQYXJhbXMpOiBSZXF1ZXN0UXVlcnlCdWlsZGVyIHtcbiAgICBjb25zdCBxYiA9IG5ldyBSZXF1ZXN0UXVlcnlCdWlsZGVyKCk7XG4gICAgcmV0dXJuIGlzT2JqZWN0KHBhcmFtcykgPyBxYi5jcmVhdGVGcm9tUGFyYW1zKHBhcmFtcykgOiBxYjtcbiAgfVxuXG4gIGdldCBvcHRpb25zKCk6IFJlcXVlc3RRdWVyeUJ1aWxkZXJPcHRpb25zIHtcbiAgICByZXR1cm4gUmVxdWVzdFF1ZXJ5QnVpbGRlci5fb3B0aW9ucztcbiAgfVxuXG4gIHNldFBhcmFtTmFtZXMoKSB7XG4gICAgT2JqZWN0LmtleXMoUmVxdWVzdFF1ZXJ5QnVpbGRlci5fb3B0aW9ucy5wYXJhbU5hbWVzTWFwKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSBSZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zLnBhcmFtTmFtZXNNYXBba2V5XTtcbiAgICAgIHRoaXMucGFyYW1OYW1lc1trZXldID0gaXNTdHJpbmcobmFtZSkgPyAobmFtZSBhcyBzdHJpbmcpIDogKG5hbWVbMF0gYXMgc3RyaW5nKTtcbiAgICB9KTtcbiAgfVxuXG4gIHF1ZXJ5KGVuY29kZSA9IHRydWUpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLnF1ZXJ5T2JqZWN0W3RoaXMucGFyYW1OYW1lcy5zZWFyY2hdKSB7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3RoaXMucGFyYW1OYW1lcy5maWx0ZXJdID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5xdWVyeU9iamVjdFt0aGlzLnBhcmFtTmFtZXMub3JdID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB0aGlzLnF1ZXJ5U3RyaW5nID0gc3RyaW5naWZ5KHRoaXMucXVlcnlPYmplY3QsIHsgZW5jb2RlIH0pO1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5U3RyaW5nO1xuICB9XG5cbiAgc2VsZWN0KGZpZWxkczogUXVlcnlGaWVsZHMpOiB0aGlzIHtcbiAgICBpZiAoaXNBcnJheUZ1bGwoZmllbGRzKSkge1xuICAgICAgdmFsaWRhdGVGaWVsZHMoZmllbGRzKTtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbdGhpcy5wYXJhbU5hbWVzLmZpZWxkc10gPSBmaWVsZHMuam9pbih0aGlzLm9wdGlvbnMuZGVsaW1TdHIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNlYXJjaChzOiBTQ29uZGl0aW9uKSB7XG4gICAgaWYgKCFpc05pbChzKSAmJiBpc09iamVjdChzKSkge1xuICAgICAgdGhpcy5xdWVyeU9iamVjdFt0aGlzLnBhcmFtTmFtZXMuc2VhcmNoXSA9IEpTT04uc3RyaW5naWZ5KHMpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldEZpbHRlcihmOiBRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyIHwgQXJyYXk8UXVlcnlGaWx0ZXIgfCBRdWVyeUZpbHRlckFycj4pOiB0aGlzIHtcbiAgICB0aGlzLnNldENvbmRpdGlvbihmLCAnZmlsdGVyJyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRPcihmOiBRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyIHwgQXJyYXk8UXVlcnlGaWx0ZXIgfCBRdWVyeUZpbHRlckFycj4pOiB0aGlzIHtcbiAgICB0aGlzLnNldENvbmRpdGlvbihmLCAnb3InKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldEpvaW4oajogUXVlcnlKb2luIHwgUXVlcnlKb2luQXJyIHwgQXJyYXk8UXVlcnlKb2luIHwgUXVlcnlKb2luQXJyPik6IHRoaXMge1xuICAgIGlmICghaXNOaWwoaikpIHtcbiAgICAgIGNvbnN0IHBhcmFtID0gdGhpcy5jaGVja1F1ZXJ5T2JqZWN0UGFyYW0oJ2pvaW4nLCBbXSk7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSA9IFtcbiAgICAgICAgLi4udGhpcy5xdWVyeU9iamVjdFtwYXJhbV0sXG4gICAgICAgIC4uLihBcnJheS5pc0FycmF5KGopICYmICFpc1N0cmluZyhqWzBdKVxuICAgICAgICAgID8gKGogYXMgQXJyYXk8UXVlcnlKb2luIHwgUXVlcnlKb2luQXJyPikubWFwKChvKSA9PiB0aGlzLmFkZEpvaW4obykpXG4gICAgICAgICAgOiBbdGhpcy5hZGRKb2luKGogYXMgUXVlcnlKb2luIHwgUXVlcnlKb2luQXJyKV0pLFxuICAgICAgXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzb3J0QnkoczogUXVlcnlTb3J0IHwgUXVlcnlTb3J0QXJyIHwgQXJyYXk8UXVlcnlTb3J0IHwgUXVlcnlTb3J0QXJyPik6IHRoaXMge1xuICAgIGlmICghaXNOaWwocykpIHtcbiAgICAgIGNvbnN0IHBhcmFtID0gdGhpcy5jaGVja1F1ZXJ5T2JqZWN0UGFyYW0oJ3NvcnQnLCBbXSk7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSA9IFtcbiAgICAgICAgLi4udGhpcy5xdWVyeU9iamVjdFtwYXJhbV0sXG4gICAgICAgIC4uLihBcnJheS5pc0FycmF5KHMpICYmICFpc1N0cmluZyhzWzBdKVxuICAgICAgICAgID8gKHMgYXMgQXJyYXk8UXVlcnlTb3J0IHwgUXVlcnlTb3J0QXJyPikubWFwKChvKSA9PiB0aGlzLmFkZFNvcnRCeShvKSlcbiAgICAgICAgICA6IFt0aGlzLmFkZFNvcnRCeShzIGFzIFF1ZXJ5U29ydCB8IFF1ZXJ5U29ydEFycildKSxcbiAgICAgIF07XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0TGltaXQobjogbnVtYmVyKTogdGhpcyB7XG4gICAgdGhpcy5zZXROdW1lcmljKG4sICdsaW1pdCcpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0T2Zmc2V0KG46IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMuc2V0TnVtZXJpYyhuLCAnb2Zmc2V0Jyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRQYWdlKG46IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMuc2V0TnVtZXJpYyhuLCAncGFnZScpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcmVzZXRDYWNoZSgpOiB0aGlzIHtcbiAgICB0aGlzLnNldE51bWVyaWMoMCwgJ2NhY2hlJyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjb25kKFxuICAgIGY6IFF1ZXJ5RmlsdGVyIHwgUXVlcnlGaWx0ZXJBcnIsXG4gICAgY29uZDogJ2ZpbHRlcicgfCAnb3InIHwgJ3NlYXJjaCcgPSAnc2VhcmNoJyxcbiAgKTogc3RyaW5nIHtcbiAgICBjb25zdCBmaWx0ZXIgPSBBcnJheS5pc0FycmF5KGYpID8geyBmaWVsZDogZlswXSwgb3BlcmF0b3I6IGZbMV0sIHZhbHVlOiBmWzJdIH0gOiBmO1xuICAgIHZhbGlkYXRlQ29uZGl0aW9uKGZpbHRlciwgY29uZCk7XG4gICAgY29uc3QgZCA9IHRoaXMub3B0aW9ucy5kZWxpbTtcblxuICAgIHJldHVybiAoXG4gICAgICBmaWx0ZXIuZmllbGQgK1xuICAgICAgZCArXG4gICAgICBmaWx0ZXIub3BlcmF0b3IgK1xuICAgICAgKGhhc1ZhbHVlKGZpbHRlci52YWx1ZSkgPyBkICsgZmlsdGVyLnZhbHVlIDogJycpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkSm9pbihqOiBRdWVyeUpvaW4gfCBRdWVyeUpvaW5BcnIpOiBzdHJpbmcge1xuICAgIGNvbnN0IGpvaW4gPSBBcnJheS5pc0FycmF5KGopID8geyBmaWVsZDogalswXSwgc2VsZWN0OiBqWzFdIH0gOiBqO1xuICAgIHZhbGlkYXRlSm9pbihqb2luKTtcbiAgICBjb25zdCBkID0gdGhpcy5vcHRpb25zLmRlbGltO1xuICAgIGNvbnN0IGRzID0gdGhpcy5vcHRpb25zLmRlbGltU3RyO1xuXG4gICAgcmV0dXJuIGpvaW4uZmllbGQgKyAoaXNBcnJheUZ1bGwoam9pbi5zZWxlY3QpID8gZCArIGpvaW4uc2VsZWN0LmpvaW4oZHMpIDogJycpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRTb3J0QnkoczogUXVlcnlTb3J0IHwgUXVlcnlTb3J0QXJyKTogc3RyaW5nIHtcbiAgICBjb25zdCBzb3J0ID0gQXJyYXkuaXNBcnJheShzKSA/IHsgZmllbGQ6IHNbMF0sIG9yZGVyOiBzWzFdIH0gOiBzO1xuICAgIHZhbGlkYXRlU29ydChzb3J0KTtcbiAgICBjb25zdCBkcyA9IHRoaXMub3B0aW9ucy5kZWxpbVN0cjtcblxuICAgIHJldHVybiBzb3J0LmZpZWxkICsgZHMgKyBzb3J0Lm9yZGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVGcm9tUGFyYW1zKHBhcmFtczogQ3JlYXRlUXVlcnlQYXJhbXMpOiB0aGlzIHtcbiAgICB0aGlzLnNlbGVjdChwYXJhbXMuZmllbGRzKTtcbiAgICB0aGlzLnNlYXJjaChwYXJhbXMuc2VhcmNoKTtcbiAgICB0aGlzLnNldEZpbHRlcihwYXJhbXMuZmlsdGVyKTtcbiAgICB0aGlzLnNldE9yKHBhcmFtcy5vcik7XG4gICAgdGhpcy5zZXRKb2luKHBhcmFtcy5qb2luKTtcbiAgICB0aGlzLnNldExpbWl0KHBhcmFtcy5saW1pdCk7XG4gICAgdGhpcy5zZXRPZmZzZXQocGFyYW1zLm9mZnNldCk7XG4gICAgdGhpcy5zZXRQYWdlKHBhcmFtcy5wYWdlKTtcbiAgICB0aGlzLnNvcnRCeShwYXJhbXMuc29ydCk7XG4gICAgaWYgKHBhcmFtcy5yZXNldENhY2hlKSB7XG4gICAgICB0aGlzLnJlc2V0Q2FjaGUoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrUXVlcnlPYmplY3RQYXJhbShcbiAgICBjb25kOiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddLFxuICAgIGRlZmF1bHRzOiBhbnksXG4gICk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW0gPSB0aGlzLnBhcmFtTmFtZXNbY29uZF07XG4gICAgaWYgKGlzTmlsKHRoaXMucXVlcnlPYmplY3RbcGFyYW1dKSAmJiAhaXNVbmRlZmluZWQoZGVmYXVsdHMpKSB7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSA9IGRlZmF1bHRzO1xuICAgIH1cbiAgICByZXR1cm4gcGFyYW07XG4gIH1cblxuICBwcml2YXRlIHNldENvbmRpdGlvbihcbiAgICBmOiBRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyIHwgQXJyYXk8UXVlcnlGaWx0ZXIgfCBRdWVyeUZpbHRlckFycj4sXG4gICAgY29uZDogJ2ZpbHRlcicgfCAnb3InLFxuICApOiB2b2lkIHtcbiAgICBpZiAoIWlzTmlsKGYpKSB7XG4gICAgICBjb25zdCBwYXJhbSA9IHRoaXMuY2hlY2tRdWVyeU9iamVjdFBhcmFtKGNvbmQsIFtdKTtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbcGFyYW1dID0gW1xuICAgICAgICAuLi50aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSxcbiAgICAgICAgLi4uKEFycmF5LmlzQXJyYXkoZikgJiYgIWlzU3RyaW5nKGZbMF0pXG4gICAgICAgICAgPyAoZiBhcyBBcnJheTxRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyPikubWFwKChvKSA9PiB0aGlzLmNvbmQobywgY29uZCkpXG4gICAgICAgICAgOiBbdGhpcy5jb25kKGYgYXMgUXVlcnlGaWx0ZXIgfCBRdWVyeUZpbHRlckFyciwgY29uZCldKSxcbiAgICAgIF07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXROdW1lcmljKG46IG51bWJlciwgY29uZDogJ2xpbWl0JyB8ICdvZmZzZXQnIHwgJ3BhZ2UnIHwgJ2NhY2hlJyk6IHZvaWQge1xuICAgIGlmICghaXNOaWwobikpIHtcbiAgICAgIHZhbGlkYXRlTnVtZXJpYyhuLCBjb25kKTtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbdGhpcy5wYXJhbU5hbWVzW2NvbmRdXSA9IG47XG4gICAgfVxuICB9XG59Il19