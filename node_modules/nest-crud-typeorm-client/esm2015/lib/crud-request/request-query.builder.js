import { hasValue, isObject, isString, isArrayFull, isNil, isUndefined, } from '../util';
import { stringify } from 'qs';
import { validateCondition, validateFields, validateJoin, validateNumeric, validateSort, } from './request-query.validator';
// tslint:disable:variable-name ban-types
export class RequestQueryBuilder {
    constructor() {
        this.paramNames = {};
        this.queryObject = {};
        this.setParamNames();
    }
    static setOptions(options) {
        RequestQueryBuilder._options = Object.assign(Object.assign(Object.assign({}, RequestQueryBuilder._options), options), { paramNamesMap: Object.assign(Object.assign({}, RequestQueryBuilder._options.paramNamesMap), (options.paramNamesMap ? options.paramNamesMap : {})) });
    }
    static getOptions() {
        return RequestQueryBuilder._options;
    }
    static create(params) {
        const qb = new RequestQueryBuilder();
        return isObject(params) ? qb.createFromParams(params) : qb;
    }
    get options() {
        return RequestQueryBuilder._options;
    }
    setParamNames() {
        Object.keys(RequestQueryBuilder._options.paramNamesMap).forEach((key) => {
            const name = RequestQueryBuilder._options.paramNamesMap[key];
            this.paramNames[key] = isString(name) ? name : name[0];
        });
    }
    query(encode = true) {
        if (this.queryObject[this.paramNames.search]) {
            this.queryObject[this.paramNames.filter] = undefined;
            this.queryObject[this.paramNames.or] = undefined;
        }
        this.queryString = stringify(this.queryObject, { encode });
        return this.queryString;
    }
    select(fields) {
        if (isArrayFull(fields)) {
            validateFields(fields);
            this.queryObject[this.paramNames.fields] = fields.join(this.options.delimStr);
        }
        return this;
    }
    search(s) {
        if (!isNil(s) && isObject(s)) {
            this.queryObject[this.paramNames.search] = JSON.stringify(s);
        }
        return this;
    }
    setFilter(f) {
        this.setCondition(f, 'filter');
        return this;
    }
    setOr(f) {
        this.setCondition(f, 'or');
        return this;
    }
    setJoin(j) {
        if (!isNil(j)) {
            const param = this.checkQueryObjectParam('join', []);
            this.queryObject[param] = [
                ...this.queryObject[param],
                ...(Array.isArray(j) && !isString(j[0])
                    ? j.map((o) => this.addJoin(o))
                    : [this.addJoin(j)]),
            ];
        }
        return this;
    }
    sortBy(s) {
        if (!isNil(s)) {
            const param = this.checkQueryObjectParam('sort', []);
            this.queryObject[param] = [
                ...this.queryObject[param],
                ...(Array.isArray(s) && !isString(s[0])
                    ? s.map((o) => this.addSortBy(o))
                    : [this.addSortBy(s)]),
            ];
        }
        return this;
    }
    setLimit(n) {
        this.setNumeric(n, 'limit');
        return this;
    }
    setOffset(n) {
        this.setNumeric(n, 'offset');
        return this;
    }
    setPage(n) {
        this.setNumeric(n, 'page');
        return this;
    }
    resetCache() {
        this.setNumeric(0, 'cache');
        return this;
    }
    cond(f, cond = 'search') {
        const filter = Array.isArray(f) ? { field: f[0], operator: f[1], value: f[2] } : f;
        validateCondition(filter, cond);
        const d = this.options.delim;
        return (filter.field +
            d +
            filter.operator +
            (hasValue(filter.value) ? d + filter.value : ''));
    }
    addJoin(j) {
        const join = Array.isArray(j) ? { field: j[0], select: j[1] } : j;
        validateJoin(join);
        const d = this.options.delim;
        const ds = this.options.delimStr;
        return join.field + (isArrayFull(join.select) ? d + join.select.join(ds) : '');
    }
    addSortBy(s) {
        const sort = Array.isArray(s) ? { field: s[0], order: s[1] } : s;
        validateSort(sort);
        const ds = this.options.delimStr;
        return sort.field + ds + sort.order;
    }
    createFromParams(params) {
        this.select(params.fields);
        this.search(params.search);
        this.setFilter(params.filter);
        this.setOr(params.or);
        this.setJoin(params.join);
        this.setLimit(params.limit);
        this.setOffset(params.offset);
        this.setPage(params.page);
        this.sortBy(params.sort);
        if (params.resetCache) {
            this.resetCache();
        }
        return this;
    }
    checkQueryObjectParam(cond, defaults) {
        const param = this.paramNames[cond];
        if (isNil(this.queryObject[param]) && !isUndefined(defaults)) {
            this.queryObject[param] = defaults;
        }
        return param;
    }
    setCondition(f, cond) {
        if (!isNil(f)) {
            const param = this.checkQueryObjectParam(cond, []);
            this.queryObject[param] = [
                ...this.queryObject[param],
                ...(Array.isArray(f) && !isString(f[0])
                    ? f.map((o) => this.cond(o, cond))
                    : [this.cond(f, cond)]),
            ];
        }
    }
    setNumeric(n, cond) {
        if (!isNil(n)) {
            validateNumeric(n, cond);
            this.queryObject[this.paramNames[cond]] = n;
        }
    }
}
RequestQueryBuilder._options = {
    delim: '||',
    delimStr: ',',
    paramNamesMap: {
        fields: ['fields', 'select'],
        search: 's',
        filter: 'filter',
        or: 'or',
        join: 'join',
        sort: 'sort',
        limit: ['limit', 'per_page'],
        offset: 'offset',
        page: 'page',
        cache: 'cache',
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1xdWVyeS5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmVzdC1jcnVkLXR5cGVvcm0tY2xpZW50LyIsInNvdXJjZXMiOlsibGliL2NydWQtcmVxdWVzdC9yZXF1ZXN0LXF1ZXJ5LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxFQUNSLFdBQVcsRUFDWCxLQUFLLEVBQ0wsV0FBVyxHQUNaLE1BQU0sU0FBUyxDQUFDO0FBQ2pCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFHL0IsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixjQUFjLEVBQ2QsWUFBWSxFQUNaLGVBQWUsRUFDZixZQUFZLEdBQ2IsTUFBTSwyQkFBMkIsQ0FBQztBQVluQyx5Q0FBeUM7QUFDekMsTUFBTSxPQUFPLG1CQUFtQjtJQUM5QjtRQW9CUSxlQUFVLEdBRWQsRUFBRSxDQUFDO1FBQ0EsZ0JBQVcsR0FBMkIsRUFBRSxDQUFDO1FBdEI5QyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQXdCRCxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQW1DO1FBQ25ELG1CQUFtQixDQUFDLFFBQVEsaURBQ3ZCLG1CQUFtQixDQUFDLFFBQVEsR0FDNUIsT0FBTyxLQUNWLGFBQWEsa0NBQ1IsbUJBQW1CLENBQUMsUUFBUSxDQUFDLGFBQWEsR0FDMUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFFMUQsQ0FBQztJQUNKLENBQUM7SUFFRCxNQUFNLENBQUMsVUFBVTtRQUNmLE9BQU8sbUJBQW1CLENBQUMsUUFBUSxDQUFDO0lBQ3RDLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQTBCO1FBQ3RDLE1BQU0sRUFBRSxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztR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QUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDckMsQ0FBQyxDQUFFLENBQXlDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDM0UsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFpQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDMUQsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVPLFVBQVUsQ0FBQyxDQUFTLEVBQUUsSUFBMkM7UUFDdkUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNiLGVBQWUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzdDO0lBQ0gsQ0FBQzs7QUFyTmMsNEJBQVEsR0FBK0I7SUFDcEQsS0FBSyxFQUFFLElBQUk7SUFDWCxRQUFRLEVBQUUsR0FBRztJQUNiLGFBQWEsRUFBRTtRQUNiLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUM7UUFDNUIsTUFBTSxFQUFFLEdBQUc7UUFDWCxNQUFNLEVBQUUsUUFBUTtRQUNoQixFQUFFLEVBQUUsSUFBSTtRQUNSLElBQUksRUFBRSxNQUFNO1FBQ1osSUFBSSxFQUFFLE1BQU07UUFDWixLQUFLLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1FBQzVCLE1BQU0sRUFBRSxRQUFRO1FBQ2hCLElBQUksRUFBRSxNQUFNO1FBQ1osS0FBSyxFQUFFLE9BQU87S0FDZjtDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBoYXNWYWx1ZSxcbiAgaXNPYmplY3QsXG4gIGlzU3RyaW5nLFxuICBpc0FycmF5RnVsbCxcbiAgaXNOaWwsXG4gIGlzVW5kZWZpbmVkLFxufSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IHN0cmluZ2lmeSB9IGZyb20gJ3FzJztcblxuaW1wb3J0IHsgUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnMsIENyZWF0ZVF1ZXJ5UGFyYW1zIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gIHZhbGlkYXRlQ29uZGl0aW9uLFxuICB2YWxpZGF0ZUZpZWxkcyxcbiAgdmFsaWRhdGVKb2luLFxuICB2YWxpZGF0ZU51bWVyaWMsXG4gIHZhbGlkYXRlU29ydCxcbn0gZnJvbSAnLi9yZXF1ZXN0LXF1ZXJ5LnZhbGlkYXRvcic7XG5pbXBvcnQge1xuICBRdWVyeUZpZWxkcyxcbiAgUXVlcnlGaWx0ZXIsXG4gIFF1ZXJ5RmlsdGVyQXJyLFxuICBRdWVyeUpvaW4sXG4gIFF1ZXJ5Sm9pbkFycixcbiAgUXVlcnlTb3J0LFxuICBRdWVyeVNvcnRBcnIsXG4gIFNDb25kaXRpb24sXG59IGZyb20gJy4vdHlwZXMnO1xuXG4vLyB0c2xpbnQ6ZGlzYWJsZTp2YXJpYWJsZS1uYW1lIGJhbi10eXBlc1xuZXhwb3J0IGNsYXNzIFJlcXVlc3RRdWVyeUJ1aWxkZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnNldFBhcmFtTmFtZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIF9vcHRpb25zOiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucyA9IHtcbiAgICBkZWxpbTogJ3x8JyxcbiAgICBkZWxpbVN0cjogJywnLFxuICAgIHBhcmFtTmFtZXNNYXA6IHtcbiAgICAgIGZpZWxkczogWydmaWVsZHMnLCAnc2VsZWN0J10sXG4gICAgICBzZWFyY2g6ICdzJyxcbiAgICAgIGZpbHRlcjogJ2ZpbHRlcicsXG4gICAgICBvcjogJ29yJyxcbiAgICAgIGpvaW46ICdqb2luJyxcbiAgICAgIHNvcnQ6ICdzb3J0JyxcbiAgICAgIGxpbWl0OiBbJ2xpbWl0JywgJ3Blcl9wYWdlJ10sXG4gICAgICBvZmZzZXQ6ICdvZmZzZXQnLFxuICAgICAgcGFnZTogJ3BhZ2UnLFxuICAgICAgY2FjaGU6ICdjYWNoZScsXG4gICAgfSxcbiAgfTtcbiAgcHJpdmF0ZSBwYXJhbU5hbWVzOiB7XG4gICAgW2tleSBpbiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddXTogc3RyaW5nO1xuICB9ID0ge307XG4gIHB1YmxpYyBxdWVyeU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuICBwdWJsaWMgcXVlcnlTdHJpbmc6IHN0cmluZztcblxuICBzdGF0aWMgc2V0T3B0aW9ucyhvcHRpb25zOiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucykge1xuICAgIFJlcXVlc3RRdWVyeUJ1aWxkZXIuX29wdGlvbnMgPSB7XG4gICAgICAuLi5SZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIHBhcmFtTmFtZXNNYXA6IHtcbiAgICAgICAgLi4uUmVxdWVzdFF1ZXJ5QnVpbGRlci5fb3B0aW9ucy5wYXJhbU5hbWVzTWFwLFxuICAgICAgICAuLi4ob3B0aW9ucy5wYXJhbU5hbWVzTWFwID8gb3B0aW9ucy5wYXJhbU5hbWVzTWFwIDoge30pLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGdldE9wdGlvbnMoKTogUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnMge1xuICAgIHJldHVybiBSZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZShwYXJhbXM/OiBDcmVhdGVRdWVyeVBhcmFtcyk6IFJlcXVlc3RRdWVyeUJ1aWxkZXIge1xuICAgIGNvbnN0IHFiID0gbmV3IFJlcXVlc3RRdWVyeUJ1aWxkZXIoKTtcbiAgICByZXR1cm4gaXNPYmplY3QocGFyYW1zKSA/IHFiLmNyZWF0ZUZyb21QYXJhbXMocGFyYW1zKSA6IHFiO1xuICB9XG5cbiAgZ2V0IG9wdGlvbnMoKTogUmVxdWVzdFF1ZXJ5QnVpbGRlck9wdGlvbnMge1xuICAgIHJldHVybiBSZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zO1xuICB9XG5cbiAgc2V0UGFyYW1OYW1lcygpIHtcbiAgICBPYmplY3Qua2V5cyhSZXF1ZXN0UXVlcnlCdWlsZGVyLl9vcHRpb25zLnBhcmFtTmFtZXNNYXApLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IFJlcXVlc3RRdWVyeUJ1aWxkZXIuX29wdGlvbnMucGFyYW1OYW1lc01hcFtrZXldO1xuICAgICAgdGhpcy5wYXJhbU5hbWVzW2tleV0gPSBpc1N0cmluZyhuYW1lKSA/IChuYW1lIGFzIHN0cmluZykgOiAobmFtZVswXSBhcyBzdHJpbmcpO1xuICAgIH0pO1xuICB9XG5cbiAgcXVlcnkoZW5jb2RlID0gdHJ1ZSk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMucXVlcnlPYmplY3RbdGhpcy5wYXJhbU5hbWVzLnNlYXJjaF0pIHtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbdGhpcy5wYXJhbU5hbWVzLmZpbHRlcl0gPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3RoaXMucGFyYW1OYW1lcy5vcl0gPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHRoaXMucXVlcnlTdHJpbmcgPSBzdHJpbmdpZnkodGhpcy5xdWVyeU9iamVjdCwgeyBlbmNvZGUgfSk7XG4gICAgcmV0dXJuIHRoaXMucXVlcnlTdHJpbmc7XG4gIH1cblxuICBzZWxlY3QoZmllbGRzOiBRdWVyeUZpZWxkcyk6IHRoaXMge1xuICAgIGlmIChpc0FycmF5RnVsbChmaWVsZHMpKSB7XG4gICAgICB2YWxpZGF0ZUZpZWxkcyhmaWVsZHMpO1xuICAgICAgdGhpcy5xdWVyeU9iamVjdFt0aGlzLnBhcmFtTmFtZXMuZmllbGRzXSA9IGZpZWxkcy5qb2luKHRoaXMub3B0aW9ucy5kZWxpbVN0cik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2VhcmNoKHM6IFNDb25kaXRpb24pIHtcbiAgICBpZiAoIWlzTmlsKHMpICYmIGlzT2JqZWN0KHMpKSB7XG4gICAgICB0aGlzLnF1ZXJ5T2JqZWN0W3RoaXMucGFyYW1OYW1lcy5zZWFyY2hdID0gSlNPTi5zdHJpbmdpZnkocyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0RmlsdGVyKGY6IFF1ZXJ5RmlsdGVyIHwgUXVlcnlGaWx0ZXJBcnIgfCBBcnJheTxRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyPik6IHRoaXMge1xuICAgIHRoaXMuc2V0Q29uZGl0aW9uKGYsICdmaWx0ZXInKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldE9yKGY6IFF1ZXJ5RmlsdGVyIHwgUXVlcnlGaWx0ZXJBcnIgfCBBcnJheTxRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyPik6IHRoaXMge1xuICAgIHRoaXMuc2V0Q29uZGl0aW9uKGYsICdvcicpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0Sm9pbihqOiBRdWVyeUpvaW4gfCBRdWVyeUpvaW5BcnIgfCBBcnJheTxRdWVyeUpvaW4gfCBRdWVyeUpvaW5BcnI+KTogdGhpcyB7XG4gICAgaWYgKCFpc05pbChqKSkge1xuICAgICAgY29uc3QgcGFyYW0gPSB0aGlzLmNoZWNrUXVlcnlPYmplY3RQYXJhbSgnam9pbicsIFtdKTtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbcGFyYW1dID0gW1xuICAgICAgICAuLi50aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSxcbiAgICAgICAgLi4uKEFycmF5LmlzQXJyYXkoaikgJiYgIWlzU3RyaW5nKGpbMF0pXG4gICAgICAgICAgPyAoaiBhcyBBcnJheTxRdWVyeUpvaW4gfCBRdWVyeUpvaW5BcnI+KS5tYXAoKG8pID0+IHRoaXMuYWRkSm9pbihvKSlcbiAgICAgICAgICA6IFt0aGlzLmFkZEpvaW4oaiBhcyBRdWVyeUpvaW4gfCBRdWVyeUpvaW5BcnIpXSksXG4gICAgICBdO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNvcnRCeShzOiBRdWVyeVNvcnQgfCBRdWVyeVNvcnRBcnIgfCBBcnJheTxRdWVyeVNvcnQgfCBRdWVyeVNvcnRBcnI+KTogdGhpcyB7XG4gICAgaWYgKCFpc05pbChzKSkge1xuICAgICAgY29uc3QgcGFyYW0gPSB0aGlzLmNoZWNrUXVlcnlPYmplY3RQYXJhbSgnc29ydCcsIFtdKTtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbcGFyYW1dID0gW1xuICAgICAgICAuLi50aGlzLnF1ZXJ5T2JqZWN0W3BhcmFtXSxcbiAgICAgICAgLi4uKEFycmF5LmlzQXJyYXkocykgJiYgIWlzU3RyaW5nKHNbMF0pXG4gICAgICAgICAgPyAocyBhcyBBcnJheTxRdWVyeVNvcnQgfCBRdWVyeVNvcnRBcnI+KS5tYXAoKG8pID0+IHRoaXMuYWRkU29ydEJ5KG8pKVxuICAgICAgICAgIDogW3RoaXMuYWRkU29ydEJ5KHMgYXMgUXVlcnlTb3J0IHwgUXVlcnlTb3J0QXJyKV0pLFxuICAgICAgXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRMaW1pdChuOiBudW1iZXIpOiB0aGlzIHtcbiAgICB0aGlzLnNldE51bWVyaWMobiwgJ2xpbWl0Jyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRPZmZzZXQobjogbnVtYmVyKTogdGhpcyB7XG4gICAgdGhpcy5zZXROdW1lcmljKG4sICdvZmZzZXQnKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldFBhZ2UobjogbnVtYmVyKTogdGhpcyB7XG4gICAgdGhpcy5zZXROdW1lcmljKG4sICdwYWdlJyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICByZXNldENhY2hlKCk6IHRoaXMge1xuICAgIHRoaXMuc2V0TnVtZXJpYygwLCAnY2FjaGUnKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGNvbmQoXG4gICAgZjogUXVlcnlGaWx0ZXIgfCBRdWVyeUZpbHRlckFycixcbiAgICBjb25kOiAnZmlsdGVyJyB8ICdvcicgfCAnc2VhcmNoJyA9ICdzZWFyY2gnLFxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IGZpbHRlciA9IEFycmF5LmlzQXJyYXkoZikgPyB7IGZpZWxkOiBmWzBdLCBvcGVyYXRvcjogZlsxXSwgdmFsdWU6IGZbMl0gfSA6IGY7XG4gICAgdmFsaWRhdGVDb25kaXRpb24oZmlsdGVyLCBjb25kKTtcbiAgICBjb25zdCBkID0gdGhpcy5vcHRpb25zLmRlbGltO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIGZpbHRlci5maWVsZCArXG4gICAgICBkICtcbiAgICAgIGZpbHRlci5vcGVyYXRvciArXG4gICAgICAoaGFzVmFsdWUoZmlsdGVyLnZhbHVlKSA/IGQgKyBmaWx0ZXIudmFsdWUgOiAnJylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRKb2luKGo6IFF1ZXJ5Sm9pbiB8IFF1ZXJ5Sm9pbkFycik6IHN0cmluZyB7XG4gICAgY29uc3Qgam9pbiA9IEFycmF5LmlzQXJyYXkoaikgPyB7IGZpZWxkOiBqWzBdLCBzZWxlY3Q6IGpbMV0gfSA6IGo7XG4gICAgdmFsaWRhdGVKb2luKGpvaW4pO1xuICAgIGNvbnN0IGQgPSB0aGlzLm9wdGlvbnMuZGVsaW07XG4gICAgY29uc3QgZHMgPSB0aGlzLm9wdGlvbnMuZGVsaW1TdHI7XG5cbiAgICByZXR1cm4gam9pbi5maWVsZCArIChpc0FycmF5RnVsbChqb2luLnNlbGVjdCkgPyBkICsgam9pbi5zZWxlY3Quam9pbihkcykgOiAnJyk7XG4gIH1cblxuICBwcml2YXRlIGFkZFNvcnRCeShzOiBRdWVyeVNvcnQgfCBRdWVyeVNvcnRBcnIpOiBzdHJpbmcge1xuICAgIGNvbnN0IHNvcnQgPSBBcnJheS5pc0FycmF5KHMpID8geyBmaWVsZDogc1swXSwgb3JkZXI6IHNbMV0gfSA6IHM7XG4gICAgdmFsaWRhdGVTb3J0KHNvcnQpO1xuICAgIGNvbnN0IGRzID0gdGhpcy5vcHRpb25zLmRlbGltU3RyO1xuXG4gICAgcmV0dXJuIHNvcnQuZmllbGQgKyBkcyArIHNvcnQub3JkZXI7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUZyb21QYXJhbXMocGFyYW1zOiBDcmVhdGVRdWVyeVBhcmFtcyk6IHRoaXMge1xuICAgIHRoaXMuc2VsZWN0KHBhcmFtcy5maWVsZHMpO1xuICAgIHRoaXMuc2VhcmNoKHBhcmFtcy5zZWFyY2gpO1xuICAgIHRoaXMuc2V0RmlsdGVyKHBhcmFtcy5maWx0ZXIpO1xuICAgIHRoaXMuc2V0T3IocGFyYW1zLm9yKTtcbiAgICB0aGlzLnNldEpvaW4ocGFyYW1zLmpvaW4pO1xuICAgIHRoaXMuc2V0TGltaXQocGFyYW1zLmxpbWl0KTtcbiAgICB0aGlzLnNldE9mZnNldChwYXJhbXMub2Zmc2V0KTtcbiAgICB0aGlzLnNldFBhZ2UocGFyYW1zLnBhZ2UpO1xuICAgIHRoaXMuc29ydEJ5KHBhcmFtcy5zb3J0KTtcbiAgICBpZiAocGFyYW1zLnJlc2V0Q2FjaGUpIHtcbiAgICAgIHRoaXMucmVzZXRDYWNoZSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tRdWVyeU9iamVjdFBhcmFtKFxuICAgIGNvbmQ6IGtleW9mIFJlcXVlc3RRdWVyeUJ1aWxkZXJPcHRpb25zWydwYXJhbU5hbWVzTWFwJ10sXG4gICAgZGVmYXVsdHM6IGFueSxcbiAgKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXJhbSA9IHRoaXMucGFyYW1OYW1lc1tjb25kXTtcbiAgICBpZiAoaXNOaWwodGhpcy5xdWVyeU9iamVjdFtwYXJhbV0pICYmICFpc1VuZGVmaW5lZChkZWZhdWx0cykpIHtcbiAgICAgIHRoaXMucXVlcnlPYmplY3RbcGFyYW1dID0gZGVmYXVsdHM7XG4gICAgfVxuICAgIHJldHVybiBwYXJhbTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q29uZGl0aW9uKFxuICAgIGY6IFF1ZXJ5RmlsdGVyIHwgUXVlcnlGaWx0ZXJBcnIgfCBBcnJheTxRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyPixcbiAgICBjb25kOiAnZmlsdGVyJyB8ICdvcicsXG4gICk6IHZvaWQge1xuICAgIGlmICghaXNOaWwoZikpIHtcbiAgICAgIGNvbnN0IHBhcmFtID0gdGhpcy5jaGVja1F1ZXJ5T2JqZWN0UGFyYW0oY29uZCwgW10pO1xuICAgICAgdGhpcy5xdWVyeU9iamVjdFtwYXJhbV0gPSBbXG4gICAgICAgIC4uLnRoaXMucXVlcnlPYmplY3RbcGFyYW1dLFxuICAgICAgICAuLi4oQXJyYXkuaXNBcnJheShmKSAmJiAhaXNTdHJpbmcoZlswXSlcbiAgICAgICAgICA/IChmIGFzIEFycmF5PFF1ZXJ5RmlsdGVyIHwgUXVlcnlGaWx0ZXJBcnI+KS5tYXAoKG8pID0+IHRoaXMuY29uZChvLCBjb25kKSlcbiAgICAgICAgICA6IFt0aGlzLmNvbmQoZiBhcyBRdWVyeUZpbHRlciB8IFF1ZXJ5RmlsdGVyQXJyLCBjb25kKV0pLFxuICAgICAgXTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldE51bWVyaWMobjogbnVtYmVyLCBjb25kOiAnbGltaXQnIHwgJ29mZnNldCcgfCAncGFnZScgfCAnY2FjaGUnKTogdm9pZCB7XG4gICAgaWYgKCFpc05pbChuKSkge1xuICAgICAgdmFsaWRhdGVOdW1lcmljKG4sIGNvbmQpO1xuICAgICAgdGhpcy5xdWVyeU9iamVjdFt0aGlzLnBhcmFtTmFtZXNbY29uZF1dID0gbjtcbiAgICB9XG4gIH1cbn0iXX0=