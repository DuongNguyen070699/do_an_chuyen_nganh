import { hasLength, hasValue, isString, isArrayFull, isDate, isDateString, isObject, isStringFull, objKeys, isNil, } from '../util';
import { RequestQueryException } from './exceptions';
import { RequestQueryBuilder } from './request-query.builder';
import { validateCondition, validateJoin, validateNumeric, validateParamOption, validateSort, validateUUID, } from './request-query.validator';
// tslint:disable:variable-name ban-types
export class RequestQueryParser {
    constructor() {
        this.fields = [];
        this.paramsFilter = [];
        this.authPersist = undefined;
        this.filter = [];
        this.or = [];
        this.join = [];
        this.sort = [];
    }
    get _options() {
        return RequestQueryBuilder.getOptions();
    }
    static create() {
        return new RequestQueryParser();
    }
    getParsed() {
        return {
            fields: this.fields,
            paramsFilter: this.paramsFilter,
            authPersist: this.authPersist,
            search: this.search,
            filter: this.filter,
            or: this.or,
            join: this.join,
            sort: this.sort,
            limit: this.limit,
            offset: this.offset,
            page: this.page,
            cache: this.cache,
        };
    }
    parseQuery(query) {
        if (isObject(query)) {
            const paramNames = objKeys(query);
            if (hasLength(paramNames)) {
                this._query = query;
                this._paramNames = paramNames;
                let searchData = this._query[this.getParamNames('search')[0]];
                this.search = this.parseSearchQueryParam(searchData);
                if (isNil(this.search)) {
                    this.filter = this.parseQueryParam('filter', this.conditionParser.bind(this, 'filter'));
                    this.or = this.parseQueryParam('or', this.conditionParser.bind(this, 'or'));
                }
                this.fields =
                    this.parseQueryParam('fields', this.fieldsParser.bind(this))[0] || [];
                this.join = this.parseQueryParam('join', this.joinParser.bind(this));
                this.sort = this.parseQueryParam('sort', this.sortParser.bind(this));
                this.limit = this.parseQueryParam('limit', this.numericParser.bind(this, 'limit'))[0];
                this.offset = this.parseQueryParam('offset', this.numericParser.bind(this, 'offset'))[0];
                this.page = this.parseQueryParam('page', this.numericParser.bind(this, 'page'))[0];
                this.cache = this.parseQueryParam('cache', this.numericParser.bind(this, 'cache'))[0];
            }
        }
        return this;
    }
    parseParams(params, options) {
        if (isObject(params)) {
            const paramNames = objKeys(params);
            if (hasLength(paramNames)) {
                this._params = params;
                this._paramsOptions = options;
                this.paramsFilter = paramNames
                    .map((name) => this.paramParser(name))
                    .filter((filter) => filter);
            }
        }
        return this;
    }
    setAuthPersist(persist = {}) {
        this.authPersist = persist || /* istanbul ignore next */ {};
    }
    convertFilterToSearch(filter) {
        const isEmptyValue = {
            isnull: true,
            notnull: true,
        };
        return filter
            ? {
                [filter.field]: {
                    [filter.operator]: isEmptyValue[filter.operator]
                        ? isEmptyValue[filter.operator]
                        : filter.value,
                },
            }
            : /* istanbul ignore next */ {};
    }
    getParamNames(type) {
        return this._paramNames.filter((p) => {
            const name = this._options.paramNamesMap[type];
            return isString(name) ? name === p : name.some((m) => m === p);
        });
    }
    getParamValues(value, parser) {
        if (isStringFull(value)) {
            return [parser.call(this, value)];
        }
        if (isArrayFull(value)) {
            return value.map((val) => parser(val));
        }
        return [];
    }
    parseQueryParam(type, parser) {
        const param = this.getParamNames(type);
        if (isArrayFull(param)) {
            return param.reduce((a, name) => Object.assign(a, this.getParamValues(this._query[name], parser)), []);
        }
        return [];
    }
    parseValue(val) {
        try {
            const parsed = JSON.parse(val);
            if (!isDate(parsed) && isObject(parsed)) {
                // throw new Error('Don\'t support object now');
                return val;
            }
            else if (typeof parsed === 'number' &&
                parsed.toLocaleString('fullwide', { useGrouping: false }) !== val) {
                // JS cannot handle big numbers. Leave it as a string to prevent data loss
                return val;
            }
            return parsed;
        }
        catch (ignored) {
            if (isDateString(val)) {
                return new Date(val);
            }
            return val;
        }
    }
    parseValues(vals) {
        if (isArrayFull(vals)) {
            return vals.map((v) => this.parseValue(v));
        }
        else {
            return this.parseValue(vals);
        }
    }
    fieldsParser(data) {
        return data.split(this._options.delimStr);
    }
    parseSearchQueryParam(d) {
        try {
            if (isNil(d)) {
                return undefined;
            }
            const data = JSON.parse(d);
            if (!isObject(data)) {
                throw new Error();
            }
            return data;
        }
        catch (_) {
            throw new RequestQueryException('Invalid search param. JSON expected');
        }
    }
    conditionParser(cond, data) {
        const isArrayValue = [
            'in',
            'notin',
            'between',
            '$in',
            '$notin',
            '$between',
            '$inL',
            '$notinL',
        ];
        const isEmptyValue = ['isnull', 'notnull', '$isnull', '$notnull'];
        const param = data.split(this._options.delim);
        const field = param[0];
        const operator = param[1];
        let value = param[2] || '';
        if (isArrayValue.some((name) => name === operator)) {
            value = value.split(this._options.delimStr);
        }
        value = this.parseValues(value);
        if (!isEmptyValue.some((name) => name === operator) && !hasValue(value)) {
            throw new RequestQueryException(`Invalid ${cond} value`);
        }
        const condition = { field, operator, value };
        validateCondition(condition, cond);
        return condition;
    }
    joinParser(data) {
        const param = data.split(this._options.delim);
        const join = {
            field: param[0],
            select: isStringFull(param[1]) ? param[1].split(this._options.delimStr) : undefined,
        };
        validateJoin(join);
        return join;
    }
    sortParser(data) {
        const param = data.split(this._options.delimStr);
        const sort = {
            field: param[0],
            order: param[1],
        };
        validateSort(sort);
        return sort;
    }
    numericParser(num, data) {
        const val = this.parseValue(data);
        validateNumeric(val, num);
        return val;
    }
    paramParser(name) {
        validateParamOption(this._paramsOptions, name);
        const option = this._paramsOptions[name];
        if (option.disabled) {
            return undefined;
        }
        let value = this._params[name];
        switch (option.type) {
            case 'number':
                value = this.parseValue(value);
                validateNumeric(value, `param ${name}`);
                break;
            case 'uuid':
                validateUUID(value, name);
                break;
            default:
                break;
        }
        return { field: option.field, operator: '$eq', value };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1xdWVyeS5wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXN0LWNydWQtdHlwZW9ybS1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvY3J1ZC1yZXF1ZXN0L3JlcXVlc3QtcXVlcnkucGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsTUFBTSxFQUNOLFlBQVksRUFDWixRQUFRLEVBQ1IsWUFBWSxFQUNaLE9BQU8sRUFDUCxLQUFLLEdBRU4sTUFBTSxTQUFTLENBQUM7QUFFakIsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBTXJELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsWUFBWSxFQUNaLGVBQWUsRUFDZixtQkFBbUIsRUFDbkIsWUFBWSxFQUNaLFlBQVksR0FDYixNQUFNLDJCQUEyQixDQUFDO0FBWW5DLHlDQUF5QztBQUN6QyxNQUFNLE9BQU8sa0JBQWtCO0lBQS9CO1FBQ1MsV0FBTSxHQUFnQixFQUFFLENBQUM7UUFDekIsaUJBQVksR0FBa0IsRUFBRSxDQUFDO1FBQ2pDLGdCQUFXLEdBQWtCLFNBQVMsQ0FBQztRQUV2QyxXQUFNLEdBQWtCLEVBQUUsQ0FBQztRQUMzQixPQUFFLEdBQWtCLEVBQUUsQ0FBQztRQUN2QixTQUFJLEdBQWdCLEVBQUUsQ0FBQztRQUN2QixTQUFJLEdBQWdCLEVBQUUsQ0FBQztJQXlTaEMsQ0FBQztJQTlSQyxJQUFZLFFBQVE7UUFDbEIsT0FBTyxtQkFBbUIsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQU07UUFDWCxPQUFPLElBQUksa0JBQWtCLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRUQsU0FBUztRQUNQLE9BQU87WUFDTCxNQUFNLEVBQUUsSUFBSSxD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QU07WUFDUjtnQkFDRSxNQUFNO1NBQ1Q7UUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBoYXNMZW5ndGgsXG4gIGhhc1ZhbHVlLFxuICBpc1N0cmluZyxcbiAgaXNBcnJheUZ1bGwsXG4gIGlzRGF0ZSxcbiAgaXNEYXRlU3RyaW5nLFxuICBpc09iamVjdCxcbiAgaXNTdHJpbmdGdWxsLFxuICBvYmpLZXlzLFxuICBpc05pbCxcbiAgT2JqZWN0TGl0ZXJhbCxcbn0gZnJvbSAnLi4vdXRpbCc7XG5cbmltcG9ydCB7IFJlcXVlc3RRdWVyeUV4Y2VwdGlvbiB9IGZyb20gJy4vZXhjZXB0aW9ucyc7XG5pbXBvcnQge1xuICBQYXJhbXNPcHRpb25zLFxuICBQYXJzZWRSZXF1ZXN0UGFyYW1zLFxuICBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucyxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFJlcXVlc3RRdWVyeUJ1aWxkZXIgfSBmcm9tICcuL3JlcXVlc3QtcXVlcnkuYnVpbGRlcic7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUNvbmRpdGlvbixcbiAgdmFsaWRhdGVKb2luLFxuICB2YWxpZGF0ZU51bWVyaWMsXG4gIHZhbGlkYXRlUGFyYW1PcHRpb24sXG4gIHZhbGlkYXRlU29ydCxcbiAgdmFsaWRhdGVVVUlELFxufSBmcm9tICcuL3JlcXVlc3QtcXVlcnkudmFsaWRhdG9yJztcbmltcG9ydCB7XG4gIENvbXBhcmlzb25PcGVyYXRvcixcbiAgUXVlcnlGaWVsZHMsXG4gIFF1ZXJ5RmlsdGVyLFxuICBRdWVyeUpvaW4sXG4gIFF1ZXJ5U29ydCxcbiAgU0NvbmRpdGlvbixcbiAgU0NvbmRpdGlvbkFORCxcbiAgU0ZpZWxkcyxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbi8vIHRzbGludDpkaXNhYmxlOnZhcmlhYmxlLW5hbWUgYmFuLXR5cGVzXG5leHBvcnQgY2xhc3MgUmVxdWVzdFF1ZXJ5UGFyc2VyIGltcGxlbWVudHMgUGFyc2VkUmVxdWVzdFBhcmFtcyB7XG4gIHB1YmxpYyBmaWVsZHM6IFF1ZXJ5RmllbGRzID0gW107XG4gIHB1YmxpYyBwYXJhbXNGaWx0ZXI6IFF1ZXJ5RmlsdGVyW10gPSBbXTtcbiAgcHVibGljIGF1dGhQZXJzaXN0OiBPYmplY3RMaXRlcmFsID0gdW5kZWZpbmVkO1xuICBwdWJsaWMgc2VhcmNoOiBTQ29uZGl0aW9uO1xuICBwdWJsaWMgZmlsdGVyOiBRdWVyeUZpbHRlcltdID0gW107XG4gIHB1YmxpYyBvcjogUXVlcnlGaWx0ZXJbXSA9IFtdO1xuICBwdWJsaWMgam9pbjogUXVlcnlKb2luW10gPSBbXTtcbiAgcHVibGljIHNvcnQ6IFF1ZXJ5U29ydFtdID0gW107XG4gIHB1YmxpYyBsaW1pdDogbnVtYmVyO1xuICBwdWJsaWMgb2Zmc2V0OiBudW1iZXI7XG4gIHB1YmxpYyBwYWdlOiBudW1iZXI7XG4gIHB1YmxpYyBjYWNoZTogbnVtYmVyO1xuXG4gIHByaXZhdGUgX3BhcmFtczogYW55O1xuICBwcml2YXRlIF9xdWVyeTogYW55O1xuICBwcml2YXRlIF9wYXJhbU5hbWVzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSBfcGFyYW1zT3B0aW9uczogUGFyYW1zT3B0aW9ucztcblxuICBwcml2YXRlIGdldCBfb3B0aW9ucygpOiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9ucyB7XG4gICAgcmV0dXJuIFJlcXVlc3RRdWVyeUJ1aWxkZXIuZ2V0T3B0aW9ucygpO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZSgpOiBSZXF1ZXN0UXVlcnlQYXJzZXIge1xuICAgIHJldHVybiBuZXcgUmVxdWVzdFF1ZXJ5UGFyc2VyKCk7XG4gIH1cblxuICBnZXRQYXJzZWQoKTogUGFyc2VkUmVxdWVzdFBhcmFtcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpZWxkczogdGhpcy5maWVsZHMsXG4gICAgICBwYXJhbXNGaWx0ZXI6IHRoaXMucGFyYW1zRmlsdGVyLFxuICAgICAgYXV0aFBlcnNpc3Q6IHRoaXMuYXV0aFBlcnNpc3QsXG4gICAgICBzZWFyY2g6IHRoaXMuc2VhcmNoLFxuICAgICAgZmlsdGVyOiB0aGlzLmZpbHRlcixcbiAgICAgIG9yOiB0aGlzLm9yLFxuICAgICAgam9pbjogdGhpcy5qb2luLFxuICAgICAgc29ydDogdGhpcy5zb3J0LFxuICAgICAgbGltaXQ6IHRoaXMubGltaXQsXG4gICAgICBvZmZzZXQ6IHRoaXMub2Zmc2V0LFxuICAgICAgcGFnZTogdGhpcy5wYWdlLFxuICAgICAgY2FjaGU6IHRoaXMuY2FjaGUsXG4gICAgfTtcbiAgfVxuXG4gIHBhcnNlUXVlcnkocXVlcnk6IGFueSk6IHRoaXMge1xuICAgIGlmIChpc09iamVjdChxdWVyeSkpIHtcbiAgICAgIGNvbnN0IHBhcmFtTmFtZXMgPSBvYmpLZXlzKHF1ZXJ5KTtcblxuICAgICAgaWYgKGhhc0xlbmd0aChwYXJhbU5hbWVzKSkge1xuICAgICAgICB0aGlzLl9xdWVyeSA9IHF1ZXJ5O1xuICAgICAgICB0aGlzLl9wYXJhbU5hbWVzID0gcGFyYW1OYW1lcztcbiAgICAgICAgbGV0IHNlYXJjaERhdGEgPSB0aGlzLl9xdWVyeVt0aGlzLmdldFBhcmFtTmFtZXMoJ3NlYXJjaCcpWzBdXTtcblxuICAgICAgICB0aGlzLnNlYXJjaCA9IHRoaXMucGFyc2VTZWFyY2hRdWVyeVBhcmFtKHNlYXJjaERhdGEpIGFzIGFueTtcbiAgICAgICAgaWYgKGlzTmlsKHRoaXMuc2VhcmNoKSkge1xuICAgICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5wYXJzZVF1ZXJ5UGFyYW0oXG4gICAgICAgICAgICAnZmlsdGVyJyxcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9uUGFyc2VyLmJpbmQodGhpcywgJ2ZpbHRlcicpLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5vciA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKCdvcicsIHRoaXMuY29uZGl0aW9uUGFyc2VyLmJpbmQodGhpcywgJ29yJykpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmllbGRzID1cbiAgICAgICAgICB0aGlzLnBhcnNlUXVlcnlQYXJhbSgnZmllbGRzJywgdGhpcy5maWVsZHNQYXJzZXIuYmluZCh0aGlzKSlbMF0gfHwgW107XG4gICAgICAgIHRoaXMuam9pbiA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKCdqb2luJywgdGhpcy5qb2luUGFyc2VyLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLnNvcnQgPSB0aGlzLnBhcnNlUXVlcnlQYXJhbSgnc29ydCcsIHRoaXMuc29ydFBhcnNlci5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5saW1pdCA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKFxuICAgICAgICAgICdsaW1pdCcsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ2xpbWl0JyksXG4gICAgICAgIClbMF07XG4gICAgICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5wYXJzZVF1ZXJ5UGFyYW0oXG4gICAgICAgICAgJ29mZnNldCcsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ29mZnNldCcpLFxuICAgICAgICApWzBdO1xuICAgICAgICB0aGlzLnBhZ2UgPSB0aGlzLnBhcnNlUXVlcnlQYXJhbShcbiAgICAgICAgICAncGFnZScsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ3BhZ2UnKSxcbiAgICAgICAgKVswXTtcbiAgICAgICAgdGhpcy5jYWNoZSA9IHRoaXMucGFyc2VRdWVyeVBhcmFtKFxuICAgICAgICAgICdjYWNoZScsXG4gICAgICAgICAgdGhpcy5udW1lcmljUGFyc2VyLmJpbmQodGhpcywgJ2NhY2hlJyksXG4gICAgICAgIClbMF07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwYXJzZVBhcmFtcyhwYXJhbXM6IGFueSwgb3B0aW9uczogUGFyYW1zT3B0aW9ucyk6IHRoaXMge1xuICAgIGlmIChpc09iamVjdChwYXJhbXMpKSB7XG4gICAgICBjb25zdCBwYXJhbU5hbWVzID0gb2JqS2V5cyhwYXJhbXMpO1xuXG4gICAgICBpZiAoaGFzTGVuZ3RoKHBhcmFtTmFtZXMpKSB7XG4gICAgICAgIHRoaXMuX3BhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgdGhpcy5fcGFyYW1zT3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMucGFyYW1zRmlsdGVyID0gcGFyYW1OYW1lc1xuICAgICAgICAgIC5tYXAoKG5hbWUpID0+IHRoaXMucGFyYW1QYXJzZXIobmFtZSkpXG4gICAgICAgICAgLmZpbHRlcigoZmlsdGVyKSA9PiBmaWx0ZXIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0QXV0aFBlcnNpc3QocGVyc2lzdDogT2JqZWN0TGl0ZXJhbCA9IHt9KSB7XG4gICAgdGhpcy5hdXRoUGVyc2lzdCA9IHBlcnNpc3QgfHwgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8ge307XG4gIH1cblxuICBjb252ZXJ0RmlsdGVyVG9TZWFyY2goZmlsdGVyOiBRdWVyeUZpbHRlcik6IFNGaWVsZHMgfCBTQ29uZGl0aW9uQU5EIHtcbiAgICBjb25zdCBpc0VtcHR5VmFsdWUgPSB7XG4gICAgICBpc251bGw6IHRydWUsXG4gICAgICBub3RudWxsOiB0cnVlLFxuICAgIH07XG5cbiAgICByZXR1cm4gZmlsdGVyXG4gICAgICA/IHtcbiAgICAgICAgICBbZmlsdGVyLmZpZWxkXToge1xuICAgICAgICAgICAgW2ZpbHRlci5vcGVyYXRvcl06IGlzRW1wdHlWYWx1ZVtmaWx0ZXIub3BlcmF0b3JdXG4gICAgICAgICAgICAgID8gaXNFbXB0eVZhbHVlW2ZpbHRlci5vcGVyYXRvcl1cbiAgICAgICAgICAgICAgOiBmaWx0ZXIudmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgOiAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLyB7fTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGFyYW1OYW1lcyhcbiAgICB0eXBlOiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddLFxuICApOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMuX3BhcmFtTmFtZXMuZmlsdGVyKChwKSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gdGhpcy5fb3B0aW9ucy5wYXJhbU5hbWVzTWFwW3R5cGVdO1xuICAgICAgcmV0dXJuIGlzU3RyaW5nKG5hbWUpID8gbmFtZSA9PT0gcCA6IChuYW1lIGFzIHN0cmluZ1tdKS5zb21lKChtKSA9PiBtID09PSBwKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGFyYW1WYWx1ZXModmFsdWU6IHN0cmluZyB8IHN0cmluZ1tdLCBwYXJzZXI6IEZ1bmN0aW9uKTogc3RyaW5nW10ge1xuICAgIGlmIChpc1N0cmluZ0Z1bGwodmFsdWUpKSB7XG4gICAgICByZXR1cm4gW3BhcnNlci5jYWxsKHRoaXMsIHZhbHVlKV07XG4gICAgfVxuXG4gICAgaWYgKGlzQXJyYXlGdWxsKHZhbHVlKSkge1xuICAgICAgcmV0dXJuICh2YWx1ZSBhcyBzdHJpbmdbXSkubWFwKCh2YWwpID0+IHBhcnNlcih2YWwpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUXVlcnlQYXJhbShcbiAgICB0eXBlOiBrZXlvZiBSZXF1ZXN0UXVlcnlCdWlsZGVyT3B0aW9uc1sncGFyYW1OYW1lc01hcCddLFxuICAgIHBhcnNlcjogRnVuY3Rpb24sXG4gICkge1xuICAgIGNvbnN0IHBhcmFtID0gdGhpcy5nZXRQYXJhbU5hbWVzKHR5cGUpO1xuXG4gICAgaWYgKGlzQXJyYXlGdWxsKHBhcmFtKSkge1xuICAgICAgcmV0dXJuIHBhcmFtLnJlZHVjZShcbiAgICAgICAgKGEsIG5hbWUpID0+IE9iamVjdC5hc3NpZ24oYSx0aGlzLmdldFBhcmFtVmFsdWVzKHRoaXMuX3F1ZXJ5W25hbWVdLCBwYXJzZXIpKSxcbiAgICAgICAgW10sXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VWYWx1ZSh2YWw6IGFueSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHZhbCk7XG5cbiAgICAgIGlmICghaXNEYXRlKHBhcnNlZCkgJiYgaXNPYmplY3QocGFyc2VkKSkge1xuICAgICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoJ0RvblxcJ3Qgc3VwcG9ydCBvYmplY3Qgbm93Jyk7XG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB0eXBlb2YgcGFyc2VkID09PSAnbnVtYmVyJyAmJlxuICAgICAgICBwYXJzZWQudG9Mb2NhbGVTdHJpbmcoJ2Z1bGx3aWRlJywgeyB1c2VHcm91cGluZzogZmFsc2UgfSkgIT09IHZhbFxuICAgICAgKSB7XG4gICAgICAgIC8vIEpTIGNhbm5vdCBoYW5kbGUgYmlnIG51bWJlcnMuIExlYXZlIGl0IGFzIGEgc3RyaW5nIHRvIHByZXZlbnQgZGF0YSBsb3NzXG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJzZWQ7XG4gICAgfSBjYXRjaCAoaWdub3JlZCkge1xuICAgICAgaWYgKGlzRGF0ZVN0cmluZyh2YWwpKSB7XG4gICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWwpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VWYWx1ZXModmFsczogYW55KSB7XG4gICAgaWYgKGlzQXJyYXlGdWxsKHZhbHMpKSB7XG4gICAgICByZXR1cm4gdmFscy5tYXAoKHY6IGFueSkgPT4gdGhpcy5wYXJzZVZhbHVlKHYpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VWYWx1ZSh2YWxzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpZWxkc1BhcnNlcihkYXRhOiBzdHJpbmcpOiBRdWVyeUZpZWxkcyB7XG4gICAgcmV0dXJuIGRhdGEuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cik7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlU2VhcmNoUXVlcnlQYXJhbShkOiBhbnkpOiBTQ29uZGl0aW9uIHtcbiAgICB0cnkge1xuICAgICAgaWYgKGlzTmlsKGQpKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGQpO1xuXG4gICAgICBpZiAoIWlzT2JqZWN0KGRhdGEpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9IGNhdGNoIChfKSB7XG4gICAgICB0aHJvdyBuZXcgUmVxdWVzdFF1ZXJ5RXhjZXB0aW9uKCdJbnZhbGlkIHNlYXJjaCBwYXJhbS4gSlNPTiBleHBlY3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29uZGl0aW9uUGFyc2VyKGNvbmQ6ICdmaWx0ZXInIHwgJ29yJyB8ICdzZWFyY2gnLCBkYXRhOiBzdHJpbmcpOiBRdWVyeUZpbHRlciB7XG4gICAgY29uc3QgaXNBcnJheVZhbHVlID0gW1xuICAgICAgJ2luJyxcbiAgICAgICdub3RpbicsXG4gICAgICAnYmV0d2VlbicsXG4gICAgICAnJGluJyxcbiAgICAgICckbm90aW4nLFxuICAgICAgJyRiZXR3ZWVuJyxcbiAgICAgICckaW5MJyxcbiAgICAgICckbm90aW5MJyxcbiAgICBdO1xuICAgIGNvbnN0IGlzRW1wdHlWYWx1ZSA9IFsnaXNudWxsJywgJ25vdG51bGwnLCAnJGlzbnVsbCcsICckbm90bnVsbCddO1xuICAgIGNvbnN0IHBhcmFtID0gZGF0YS5zcGxpdCh0aGlzLl9vcHRpb25zLmRlbGltKTtcbiAgICBjb25zdCBmaWVsZCA9IHBhcmFtWzBdO1xuICAgIGNvbnN0IG9wZXJhdG9yID0gcGFyYW1bMV0gYXMgQ29tcGFyaXNvbk9wZXJhdG9yO1xuICAgIGxldCB2YWx1ZSA9IHBhcmFtWzJdIHx8ICcnO1xuXG4gICAgaWYgKGlzQXJyYXlWYWx1ZS5zb21lKChuYW1lKSA9PiBuYW1lID09PSBvcGVyYXRvcikpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cikgYXMgYW55O1xuICAgIH1cblxuICAgIHZhbHVlID0gdGhpcy5wYXJzZVZhbHVlcyh2YWx1ZSk7XG5cbiAgICBpZiAoIWlzRW1wdHlWYWx1ZS5zb21lKChuYW1lKSA9PiBuYW1lID09PSBvcGVyYXRvcikgJiYgIWhhc1ZhbHVlKHZhbHVlKSkge1xuICAgICAgdGhyb3cgbmV3IFJlcXVlc3RRdWVyeUV4Y2VwdGlvbihgSW52YWxpZCAke2NvbmR9IHZhbHVlYCk7XG4gICAgfVxuXG4gICAgY29uc3QgY29uZGl0aW9uOiBRdWVyeUZpbHRlciA9IHsgZmllbGQsIG9wZXJhdG9yLCB2YWx1ZSB9O1xuICAgIHZhbGlkYXRlQ29uZGl0aW9uKGNvbmRpdGlvbiwgY29uZCk7XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBqb2luUGFyc2VyKGRhdGE6IHN0cmluZyk6IFF1ZXJ5Sm9pbiB7XG4gICAgY29uc3QgcGFyYW0gPSBkYXRhLnNwbGl0KHRoaXMuX29wdGlvbnMuZGVsaW0pO1xuICAgIGNvbnN0IGpvaW46IFF1ZXJ5Sm9pbiA9IHtcbiAgICAgIGZpZWxkOiBwYXJhbVswXSxcbiAgICAgIHNlbGVjdDogaXNTdHJpbmdGdWxsKHBhcmFtWzFdKSA/IHBhcmFtWzFdLnNwbGl0KHRoaXMuX29wdGlvbnMuZGVsaW1TdHIpIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgdmFsaWRhdGVKb2luKGpvaW4pO1xuXG4gICAgcmV0dXJuIGpvaW47XG4gIH1cblxuICBwcml2YXRlIHNvcnRQYXJzZXIoZGF0YTogc3RyaW5nKTogUXVlcnlTb3J0IHtcbiAgICBjb25zdCBwYXJhbSA9IGRhdGEuc3BsaXQodGhpcy5fb3B0aW9ucy5kZWxpbVN0cik7XG4gICAgY29uc3Qgc29ydDogUXVlcnlTb3J0ID0ge1xuICAgICAgZmllbGQ6IHBhcmFtWzBdLFxuICAgICAgb3JkZXI6IHBhcmFtWzFdIGFzIGFueSxcbiAgICB9O1xuICAgIHZhbGlkYXRlU29ydChzb3J0KTtcblxuICAgIHJldHVybiBzb3J0O1xuICB9XG5cbiAgcHJpdmF0ZSBudW1lcmljUGFyc2VyKFxuICAgIG51bTogJ2xpbWl0JyB8ICdvZmZzZXQnIHwgJ3BhZ2UnIHwgJ2NhY2hlJyxcbiAgICBkYXRhOiBzdHJpbmcsXG4gICk6IG51bWJlciB7XG4gICAgY29uc3QgdmFsID0gdGhpcy5wYXJzZVZhbHVlKGRhdGEpO1xuICAgIHZhbGlkYXRlTnVtZXJpYyh2YWwsIG51bSk7XG5cbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJhbVBhcnNlcihuYW1lOiBzdHJpbmcpOiBRdWVyeUZpbHRlciB7XG4gICAgdmFsaWRhdGVQYXJhbU9wdGlvbih0aGlzLl9wYXJhbXNPcHRpb25zLCBuYW1lKTtcbiAgICBjb25zdCBvcHRpb24gPSB0aGlzLl9wYXJhbXNPcHRpb25zW25hbWVdO1xuXG4gICAgaWYgKG9wdGlvbi5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBsZXQgdmFsdWUgPSB0aGlzLl9wYXJhbXNbbmFtZV07XG5cbiAgICBzd2l0Y2ggKG9wdGlvbi50eXBlKSB7XG4gICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICB2YWx1ZSA9IHRoaXMucGFyc2VWYWx1ZSh2YWx1ZSk7XG4gICAgICAgIHZhbGlkYXRlTnVtZXJpYyh2YWx1ZSwgYHBhcmFtICR7bmFtZX1gKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd1dWlkJzpcbiAgICAgICAgdmFsaWRhdGVVVUlEKHZhbHVlLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4geyBmaWVsZDogb3B0aW9uLmZpZWxkLCBvcGVyYXRvcjogJyRlcScsIHZhbHVlIH07XG4gIH1cbn1cbiJdfQ==